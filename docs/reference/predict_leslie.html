<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>predictnarwsim &lt;- function(obj,
                            yrs = 35,
                            n = 100) 
  
  # if(is.null(obj$gam)) stop("Insufficient data available. Cannot proceed with population projections.")
  # if(!identical(cohortID, 1:6)) stop("Missing cohorts in input &lt;obj&gt;. Cannot proceed with population projections.")
  # if(length(obj$gam$fit$surv$xlevels[[1]]) &lt; 6 | length(obj$gam$fit$bc$xlevels[[1]]) &lt; 6) stop("Missing factor levels in input &lt;obj&gt;. Cannot proceed with population projections.")
  
  # plogis("link" predictions + error)
  
  # Adapted from original code by Scott Creel
  # https://www.montana.edu/screel/teaching/bioe-440r-521/course-outline/stoch_projection_new.R
  # 
  # Prediction intervals
  # https://stat.ethz.ch/pipermail/r-help/2011-April/275632.html
  
  # Population estimate as per 2022 NARW report card is 340 (+/- 7).
  
  # test &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = seq(0,0.6, 0.01)), type = "link", se.fit = TRUE)
  # plot(seq(0,0.6, 0.01), plogis(test$fit), type = "l")
  # lines(seq(0,0.6, 0.01), plogis(Reduce("+", test)), lty = 2)
  # lines(seq(0,0.6, 0.01), plogis(Reduce("-", test)), lty = 2)
  # test2 &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = 0.2), type = "response")
  # abline(v = 0.2)
  # abline(h = tesct2)
  
  cohortID &lt;- obj$param$cohortID
  cohorts &lt;- obj$param$cohorts |&gt; dplyr::slice(1) |&gt; 
    dplyr::mutate(name = gsub(", female", "", name), abb = gsub(",f", "", abb)) |&gt; 
    dplyr::bind_rows(obj$param$cohorts) |&gt; 
    dplyr::mutate(name = gsub("male, female", "female", name), abb = gsub("m,f", "f", abb))
  cohorts &lt;- cohorts[c(1,3,5,2,4,6,7,8)]
  
  # Attributes to monitor during projection
  mat.attribs &lt;- c("alive", "cohort", "female", "age", "length", "length_a", "length_b", "length_c",
                   "tot_mass", "lean_mass", "bc", "mass_a", "mass_b", "p_surv", "min_bc", "calving_int", "t2calf", "birth")
  
  # Current year
  current.yr &lt;- lubridate::year(lubridate::now())
  
  # Extract terminal functions
  mod &lt;- obj$gam$fit
  mod[["gest"]] &lt;- gam_gest
  
  #'------------------------------------------------------
  # INITIALIZATION
  #'------------------------------------------------------
  
  # Define initial population vector
  N0 &lt;- c(2, 5, 212, 2, 69, 1, 7, 61)
  names(N0) &lt;- cohorts[, name]
  
  # Create matrices and initialize them
  # rows: years &lt;yrs&gt;
  # columns: &lt;attributes&gt;
  # layers: individuals &lt;n&gt;
  # 4th dimension: replicate projection -&gt; later converted to list
  narw.indiv &lt;- array(data = NA, c(yrs + 1, length(mat.attribs), sum(N0), n), 
                      dimnames = list(paste0("yr ", 0:yrs), 
                                      mat.attribs,
                                      paste0("whale ", 1:sum(N0)),
                                      paste0("prj ", 1:n)))
  
  cohort.vec &lt;- do.call(c, sapply(X = 1:nrow(cohorts), FUN = function(x) rep(cohorts$id[x], each = N0[x])))
  
  # Alive and population cohort
  narw.indiv[1,"alive",,] &lt;- 1
  narw.indiv[1,"cohort",,] &lt;- rep(cohort.vec, n)
  
  # Sex
  #  -- Calves (male)
  narw.indiv[,"female", 1:N0[1], ] &lt;- 0  
  #  -- Calves (female)
  fem &lt;- which(cohort.vec == 0)
  narw.indiv[,"female", fem[fem &gt; N0[1]], ] &lt;- 1   
  #  -- Juveniles and adults
  narw.indiv[,"female", which(cohort.vec 
  narw.indiv[,"female", which(cohort.vec 
  
  # Age
  ages &lt;- start_age_vec(rep(cohort.vec, n))
  narw.indiv[1,"age", , ] &lt;- ages
  
  # Total body length
  l.params &lt;- agL_vec(ages)
  lengths &lt;- age2length_vec(ages, l.params)
  narw.indiv[1,"length", , ] &lt;- lengths
  narw.indiv[,"length_a",,] &lt;- rep(l.params[,1], each = yrs + 1)
  narw.indiv[,"length_b",,] &lt;- rep(l.params[,2], each = yrs + 1)
  narw.indiv[,"length_c",,] &lt;- rep(l.params[,3], each = yrs + 1)
  
  # Total mass
  m.params &lt;- mL(n*sum(N0))
  mass &lt;- length2mass_vec(lengths, m.params, FALSE)
  narw.indiv[,"mass_a",,] &lt;- rep(m.params[,1], each = yrs + 1)
  narw.indiv[,"mass_b",,] &lt;- rep(m.params[,2], each = yrs + 1)
  narw.indiv[1,"tot_mass", , ] &lt;- mass
  
  # Body conditon
  narw.indiv[1,"bc",,] &lt;- start_bcondition_vec(rep(cohort.vec, n))
  
  # lean mass
  narw.indiv[1,"lean_mass", , ] &lt;- mass - (narw.indiv[1,"bc",,] * mass)
  
  # Calving interval - mean of 5.3 years, up to apparent gaps of 13 years (Kraus et al. 2001)
  # NARWC Report Card 2022: Average inter-birth interval of 7.7 yrs, median of 8, min/max (2/13)
  # This corresponds to a Normal (7.7, 1.45)
  # Mean age at first calving = 9.53 +/- 2.32 (Kraus et al. 2001)
  # 
  # Stewart et al. 2022 -- 
  # The degree to which the energetic reserves of females are depleted during lactation may govern
  # the length of the resting period between successful pregnancies (Miller et al. 2011, Marón et al. 2015).
  narw.indiv[1,"calving_int",,] &lt;- (rep(cohort.vec, n) == 6) * rnorm(sum(N0)*n, mean = 7.7, sd = 1.45)
  narw.indiv[1,"t2calf",,] &lt;- round(narw.indiv[1,"calving_int",,],0)
  
  narw.indiv[1,"min_bc",,] &lt;- predict_m(model = mod,
                                        values = as.vector(narw.indiv[1,"tot_mass",,]), 
                                        prediction = "gest") * as.vector(narw.indiv[1, "cohort",, ] == 6)
  narw.indiv[1,"birth",,] &lt;- 0
  narw.indiv[1,"p_surv",,] &lt;- 1
  
  #' ---------------------------
  # IMPORTANT 
  #' ---------------------------
  # Turn array into a list - otherwise cannot add new calves within projections
  narw.indiv &lt;- purrr::array_branch(narw.indiv, 4) 
  
  # Number of individuals in each cohort
  narw.pop &lt;- array(data = NA, c(n, yrs + 1, length(N0)), 
                    dimnames = list(paste0("prj ", 1:n),
                                    paste0("yr ", 0:yrs), 
                                    cohorts$name))
  narw.pop[,1,] &lt;- rep(N0, each = n)
  
  # Total population size
  tot.pop &lt;- matrix(0, n, yrs + 1, dimnames = list(paste0("prj",1:n), paste0("yr ", 0:yrs)))
  tot.pop[,1] &lt;- sum(N0)
  
  #'------------------------------------------------------
  # RUN PROJECTIONS
  #'------------------------------------------------------
  
  # This uses nested loops. 
  # The prj loop (outermost loop) replicates the projection &lt;n&gt; times.
  # The i loop is next, and steps across all years of projection from an initial population vector.
  
  # Set up progress bar
  pb &lt;- progress::progress_bar$new(
    format = "[:bar] :percent eta: :eta",
    total = n, clear = FALSE, width = 80
  )
  
  for(prj in 1:n)
    
    pb$tick() # Update progress bar
    
    #'------------------------------------------------------
    # Loop over years
    #'------------------------------------------------------
    
    for(i in 2:(yrs+1))
      
      current.dat &lt;- as.matrix(narw.indiv[[prj]][i-1, , ])
      alive &lt;- narw.indiv[[prj]][i-1, "alive", ]
      
      #' ----------------------------
      # SURVIVAL
      #' ----------------------------
      # Predict survival probability based on body condition
      ps &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",], values = current.dat["bc",], prediction = "surv")
      narw.indiv[[prj]][i, "p_surv", ] &lt;- ps
      
      # Determine whether the animal survived
      # Maximum longevity of 69 years
      alive &lt;- rbinom(n = dim(narw.indiv[[prj]])[3], size = 1, prob = ps) * (narw.indiv[[prj]][i-1, "age", ] &lt;=69)
      narw.indiv[[prj]][i, "alive", ] &lt;- alive
      
      # Sex remains the same
      narw.indiv[[prj]][i, "female", ] &lt;- narw.indiv[[prj]][i-1, "female", ]
      
      #' ----------------------------
      # GROWTH
      #' ----------------------------
      
      # Increment age
      narw.indiv[[prj]][i, "age", ] &lt;- alive * narw.indiv[[prj]][i-1, "age", ] + 1
      
      # Increment length
      narw.indiv[[prj]][i,"length", ] &lt;- alive * age2length_vec(narw.indiv[[prj]][i, "age", ],
                                                                t(narw.indiv[[prj]][i, c("length_a", "length_b", "length_c"),]))
      
      # Increment lean mass
      narw.indiv[[prj]][i,"lean_mass", ] &lt;- alive * length2mass_vec(narw.indiv[[prj]][i, "length", ],
                                                                    t(narw.indiv[[prj]][i, c("mass_a", "mass_b"),]), lean = TRUE)
      
      # Predict new body condition from current body condition
      narw.indiv[[prj]][i, "bc", ] &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",],
                                                        values = current.dat["bc",], prediction = "bc")
      
      # Increment total mass
      narw.indiv[[prj]][i,"tot_mass", ] &lt;- alive * narw.indiv[[prj]][i,"lean_mass", ] / (1 - narw.indiv[[prj]][i,"bc", ])
      
      #' ----------------------------
      # REPRODUCTION
      #' ----------------------------
      
      narw.indiv[[prj]][i, "calving_int", ] &lt;- alive * narw.indiv[[prj]][i-1, "calving_int", ]
      narw.indiv[[prj]][i, "t2calf", ] &lt;- ifelse(narw.indiv[[prj]][i-1, "t2calf", ] - 1 &lt; 0, 0, narw.indiv[[prj]][i-1, "t2calf", ] - 1)
      
      # Minimum body condition needed to successfully bring fetus to term without starving
      # No evidence of reproductive senescence in right whales - Hamilton et al. (1998)
      narw.indiv[[prj]][i, "min_bc", ] &lt;- alive * predict_m(model = mod, values = narw.indiv[[prj]][i, "tot_mass", ], 
                                                            prediction = "gest") * (narw.indiv[[prj]][i-1, "cohort", ] == 6)
      
      # Birth of new calf
      narw.indiv[[prj]][i, "birth", ] &lt;- alive * (narw.indiv[[prj]][i, "bc", ] &gt;= narw.indiv[[prj]][i, "min_bc", ]) * 
        (narw.indiv[[prj]][i-1, "cohort", ] == 6) * (narw.indiv[[prj]][i-1, "birth", ] == 0)
      
      # Maturity - transitions between cohorts
      narw.indiv[[prj]][i, "cohort", ] &lt;- alive * increment_cohort(cohort = narw.indiv[[prj]][i-1, "cohort", ],
                                                                   age = narw.indiv[[prj]][i, "age", ],
                                                                   female = narw.indiv[[prj]][i, "female", ],
                                                                   t2calf = narw.indiv[[prj]][i, "t2calf", ])
      
      # New births
      # narw.indiv[[prj]] &lt;- new_calf(narw.indiv[[prj]][,,], year = i, attrib = mat.attribs)
      
      # Number of animals in each cohort
      # Calves (male)
      narw.pop[prj, i, 1] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 0) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Juveniles and adults (male)
      narw.pop[prj, i, 2] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 1) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 3] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 3) * (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Calves (female)
      narw.pop[prj, i, 4] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 1) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Juvenile and reproductive adults (female)
      narw.pop[prj, i, 5] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 2) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 6] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 4) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 7] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 5) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 8] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 6) * (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Total population size
      tot.pop[prj, i] &lt;- sum(narw.indiv[[prj]][i, "alive", ], na.rm = TRUE)
      
     # End years
   # End projections
  
  # Compile outputs
  narw.df &lt;- purrr::map(.x = cohorts$name, .f = ~
    narw.pop[,,.x] |&gt; 
      tibble::as_tibble() |&gt; 
      tibble::rownames_to_column(var = "prj") |&gt; 
      tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
      dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
      dplyr::mutate(cohort = stringr::str_to_sentence(.x))
  ) |&gt; do.call(what = rbind) |&gt; data.table::data.table()
  
  tot.df &lt;- tibble::as_tibble(tot.pop) |&gt; 
    tibble::rownames_to_column(var = "prj") |&gt; 
    tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
    dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
    dplyr::mutate(cohort = "North Atlantic right whales") |&gt; data.table::data.table()
  
  narw.conf &lt;- narw.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)] |&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)")))
  
  tot.conf &lt;- tot.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)]|&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)",
                                                     "North Atlantic right whales")))
  
  p1 &lt;- plot_projection(narw.df, narw.conf)
  p2 &lt;- plot_projection(tot.df, tot.conf)
  
  print(p1)
  print(p2)
  
  # Find 95
  cat("Final population size:")
  final.pop &lt;- unname(tot.df[year == current.yr + yrs,  quantile(N, probs = c(0.5, 0.025, 0.975))])
  cat("N = ", final.pop[1], " (95
  
  return(list(ind = narw.indiv, df = rbind(narw.df, tot.df), ci = rbind(narw.conf, tot.conf)))
  

---------------------------- — predict_leslie • narwind</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="predictnarwsim &lt;- function(obj,
                            yrs = 35,
                            n = 100) 
  
  # if(is.null(obj$gam)) stop(" insufficient data available. cannot proceed with population projections. if stop cohorts in input length factor levels plogis predictions error adapted from original code by scott creel https: prediction intervals estimate as per narw report card is test mgcv::predict.gam newdata="data.frame(start_bc" seq type="link" se.fit="TRUE)" plot lines lty="2)" test2 abline tesct2 cohortid obj dplyr::slice dplyr::mutate gsub female name abb='gsub(",f",' dplyr::bind_rows attributes to monitor during projection mat.attribs c current year current.yr lubridate::year extract terminal functions mod gam_gest initialization define initial vector n0 names create matrices and initialize them rows: years columns: layers: individuals dimension: replicate later converted list narw.indiv array na sum n dimnames='list(paste0("yr' paste0 cohort.vec do.call sapply fun="function(x)" rep each="N0[x])))" alive cohort sex calves fem which juveniles adults age ages start_age_vec total body l.params agl_vec lengths age2length_vec mass m.params ml length2mass_vec false conditon start_bcondition_vec lean calving interval mean of up apparent gaps et al. narwc average inter-birth yrs median min this corresponds a normal at first stewart the degree energetic reserves females are depleted lactation may govern resting period between successful pregnancies mar rnorm sd="1.45)" round predict_m values='as.vector(narw.indiv[1,"tot_mass",,]),' as.vector important turn into otherwise add new within projections purrr::array_branch number narw.pop size tot.pop matrix run uses nested loops. prj loop replicates times. i next steps across all an vector. set progress bar pb progress::progress_bar format="[:bar] :percent eta: :eta" clear="FALSE," width="80" for update over current.dat as.matrix survival predict probability based on condition ps determine whether animal survived maximum longevity rbinom dim prob="ps)" remains same growth increment t reproduction ifelse minimum needed successfully bring fetus term without starving no evidence reproductive senescence right whales hamilton birth calf maturity transitions increment_cohort t2calf="narw.indiv[[prj]][i," births new_calf attrib="mat.attribs)" animals juvenile na.rm="TRUE)" end compile outputs narw.df purrr::map .f="~" tibble::as_tibble tibble::rownames_to_column tidyr::pivot_longer names_to="year" values_to="N" as.numeric stringr::str_to_sentence rbind data.table::data.table tot.df atlantic narw.conf lwr="quantile(N," uppr="quantile(N," pregnant lactating tot.conf p1 plot_projection p2 print find cat size: final.pop unname quantile probs="c(0.5," return df="rbind(narw.df," ci="rbind(narw.conf," predict_leslie><meta property="og:description" content="predictnarwsim &amp;lt;- function(obj,
                            yrs = 35,
                            n = 100)   # if(is.null(obj$gam)) stop(&quot;Insufficient data available. Cannot proceed with population projections.&quot;)
  # if(!identical(cohortID, 1:6)) stop(&quot;Missing cohorts in input &amp;lt;obj&amp;gt;. Cannot proceed with population projections.&quot;)
  # if(length(obj$gam$fit$surv$xlevels[[1]]) &amp;lt; 6 | length(obj$gam$fit$bc$xlevels[[1]]) &amp;lt; 6) stop(&quot;Missing factor levels in input &amp;lt;obj&amp;gt;. Cannot proceed with population projections.&quot;)  # plogis(&quot;link&quot; predictions + error)  # Adapted from original code by Scott Creel
  # https://www.montana.edu/screel/teaching/bioe-440r-521/course-outline/stoch_projection_new.R
  # 
  # Prediction intervals
  # https://stat.ethz.ch/pipermail/r-help/2011-April/275632.html  # Population estimate as per 2022 NARW report card is 340 (+/- 7).  # test &amp;lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = seq(0,0.6, 0.01)), type = &quot;link&quot;, se.fit = TRUE)
  # plot(seq(0,0.6, 0.01), plogis(test$fit), type = &quot;l&quot;)
  # lines(seq(0,0.6, 0.01), plogis(Reduce(&quot;+&quot;, test)), lty = 2)
  # lines(seq(0,0.6, 0.01), plogis(Reduce(&quot;-&quot;, test)), lty = 2)
  # test2 &amp;lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = 0.2), type = &quot;response&quot;)
  # abline(v = 0.2)
  # abline(h = tesct2)  cohortID &amp;lt;- obj$param$cohortID
  cohorts &amp;lt;- obj$param$cohorts |&amp;gt; dplyr::slice(1) |&amp;gt; 
    dplyr::mutate(name = gsub(&quot;, female&quot;, &quot;&quot;, name), abb = gsub(&quot;,f&quot;, &quot;&quot;, abb)) |&amp;gt; 
    dplyr::bind_rows(obj$param$cohorts) |&amp;gt; 
    dplyr::mutate(name = gsub(&quot;male, female&quot;, &quot;female&quot;, name), abb = gsub(&quot;m,f&quot;, &quot;f&quot;, abb))
  cohorts &amp;lt;- cohorts[c(1,3,5,2,4,6,7,8)]  # Attributes to monitor during projection
  mat.attribs &amp;lt;- c(&quot;alive&quot;, &quot;cohort&quot;, &quot;female&quot;, &quot;age&quot;, &quot;length&quot;, &quot;length_a&quot;, &quot;length_b&quot;, &quot;length_c&quot;,
                   &quot;tot_mass&quot;, &quot;lean_mass&quot;, &quot;bc&quot;, &quot;mass_a&quot;, &quot;mass_b&quot;, &quot;p_surv&quot;, &quot;min_bc&quot;, &quot;calving_int&quot;, &quot;t2calf&quot;, &quot;birth&quot;)  # Current year
  current.yr &amp;lt;- lubridate::year(lubridate::now())  # Extract terminal functions
  mod &amp;lt;- obj$gam$fit
  mod[[&quot;gest&quot;]] &amp;lt;- gam_gest  #'------------------------------------------------------
  # INITIALIZATION
  #'------------------------------------------------------  # Define initial population vector
  N0 &amp;lt;- c(2, 5, 212, 2, 69, 1, 7, 61)
  names(N0) &amp;lt;- cohorts[, name]  # Create matrices and initialize them
  # rows: years &amp;lt;yrs&amp;gt;
  # columns: &amp;lt;attributes&amp;gt;
  # layers: individuals &amp;lt;n&amp;gt;
  # 4th dimension: replicate projection -&amp;gt; later converted to list
  narw.indiv &amp;lt;- array(data = NA, c(yrs + 1, length(mat.attribs), sum(N0), n), 
                      dimnames = list(paste0(&quot;yr &quot;, 0:yrs), 
                                      mat.attribs,
                                      paste0(&quot;whale &quot;, 1:sum(N0)),
                                      paste0(&quot;prj &quot;, 1:n)))  cohort.vec &amp;lt;- do.call(c, sapply(X = 1:nrow(cohorts), FUN = function(x) rep(cohorts$id[x], each = N0[x])))  # Alive and population cohort
  narw.indiv[1,&quot;alive&quot;,,] &amp;lt;- 1
  narw.indiv[1,&quot;cohort&quot;,,] &amp;lt;- rep(cohort.vec, n)  # Sex
  #  -- Calves (male)
  narw.indiv[,&quot;female&quot;, 1:N0[1], ] &amp;lt;- 0  
  #  -- Calves (female)
  fem &amp;lt;- which(cohort.vec == 0)
  narw.indiv[,&quot;female&quot;, fem[fem &amp;gt; N0[1]], ] &amp;lt;- 1   
  #  -- Juveniles and adults
  narw.indiv[,&quot;female&quot;, which(cohort.vec 
  narw.indiv[,&quot;female&quot;, which(cohort.vec   # Age
  ages &amp;lt;- start_age_vec(rep(cohort.vec, n))
  narw.indiv[1,&quot;age&quot;, , ] &amp;lt;- ages  # Total body length
  l.params &amp;lt;- agL_vec(ages)
  lengths &amp;lt;- age2length_vec(ages, l.params)
  narw.indiv[1,&quot;length&quot;, , ] &amp;lt;- lengths
  narw.indiv[,&quot;length_a&quot;,,] &amp;lt;- rep(l.params[,1], each = yrs + 1)
  narw.indiv[,&quot;length_b&quot;,,] &amp;lt;- rep(l.params[,2], each = yrs + 1)
  narw.indiv[,&quot;length_c&quot;,,] &amp;lt;- rep(l.params[,3], each = yrs + 1)  # Total mass
  m.params &amp;lt;- mL(n*sum(N0))
  mass &amp;lt;- length2mass_vec(lengths, m.params, FALSE)
  narw.indiv[,&quot;mass_a&quot;,,] &amp;lt;- rep(m.params[,1], each = yrs + 1)
  narw.indiv[,&quot;mass_b&quot;,,] &amp;lt;- rep(m.params[,2], each = yrs + 1)
  narw.indiv[1,&quot;tot_mass&quot;, , ] &amp;lt;- mass  # Body conditon
  narw.indiv[1,&quot;bc&quot;,,] &amp;lt;- start_bcondition_vec(rep(cohort.vec, n))  # lean mass
  narw.indiv[1,&quot;lean_mass&quot;, , ] &amp;lt;- mass - (narw.indiv[1,&quot;bc&quot;,,] * mass)  # Calving interval - mean of 5.3 years, up to apparent gaps of 13 years (Kraus et al. 2001)
  # NARWC Report Card 2022: Average inter-birth interval of 7.7 yrs, median of 8, min/max (2/13)
  # This corresponds to a Normal (7.7, 1.45)
  # Mean age at first calving = 9.53 +/- 2.32 (Kraus et al. 2001)
  # 
  # Stewart et al. 2022 -- 
  # The degree to which the energetic reserves of females are depleted during lactation may govern
  # the length of the resting period between successful pregnancies (Miller et al. 2011, Marón et al. 2015).
  narw.indiv[1,&quot;calving_int&quot;,,] &amp;lt;- (rep(cohort.vec, n) == 6) * rnorm(sum(N0)*n, mean = 7.7, sd = 1.45)
  narw.indiv[1,&quot;t2calf&quot;,,] &amp;lt;- round(narw.indiv[1,&quot;calving_int&quot;,,],0)  narw.indiv[1,&quot;min_bc&quot;,,] &amp;lt;- predict_m(model = mod,
                                        values = as.vector(narw.indiv[1,&quot;tot_mass&quot;,,]), 
                                        prediction = &quot;gest&quot;) * as.vector(narw.indiv[1, &quot;cohort&quot;,, ] == 6)
  narw.indiv[1,&quot;birth&quot;,,] &amp;lt;- 0
  narw.indiv[1,&quot;p_surv&quot;,,] &amp;lt;- 1  #' ---------------------------
  # IMPORTANT 
  #' ---------------------------
  # Turn array into a list - otherwise cannot add new calves within projections
  narw.indiv &amp;lt;- purrr::array_branch(narw.indiv, 4)   # Number of individuals in each cohort
  narw.pop &amp;lt;- array(data = NA, c(n, yrs + 1, length(N0)), 
                    dimnames = list(paste0(&quot;prj &quot;, 1:n),
                                    paste0(&quot;yr &quot;, 0:yrs), 
                                    cohorts$name))
  narw.pop[,1,] &amp;lt;- rep(N0, each = n)  # Total population size
  tot.pop &amp;lt;- matrix(0, n, yrs + 1, dimnames = list(paste0(&quot;prj&quot;,1:n), paste0(&quot;yr &quot;, 0:yrs)))
  tot.pop[,1] &amp;lt;- sum(N0)  #'------------------------------------------------------
  # RUN PROJECTIONS
  #'------------------------------------------------------  # This uses nested loops. 
  # The prj loop (outermost loop) replicates the projection &amp;lt;n&amp;gt; times.
  # The i loop is next, and steps across all years of projection from an initial population vector.  # Set up progress bar
  pb &amp;lt;- progress::progress_bar$new(
    format = &quot;[:bar] :percent eta: :eta&quot;,
    total = n, clear = FALSE, width = 80
  )  for(prj in 1:n)    pb$tick() # Update progress bar    #'------------------------------------------------------
    # Loop over years
    #'------------------------------------------------------    for(i in 2:(yrs+1))      current.dat &amp;lt;- as.matrix(narw.indiv[[prj]][i-1, , ])
      alive &amp;lt;- narw.indiv[[prj]][i-1, &quot;alive&quot;, ]      #' ----------------------------
      # SURVIVAL
      #' ----------------------------
      # Predict survival probability based on body condition
      ps &amp;lt;- alive * predict_m(model = mod, cohort = current.dat[&quot;cohort&quot;,], values = current.dat[&quot;bc&quot;,], prediction = &quot;surv&quot;)
      narw.indiv[[prj]][i, &quot;p_surv&quot;, ] &amp;lt;- ps      # Determine whether the animal survived
      # Maximum longevity of 69 years
      alive &amp;lt;- rbinom(n = dim(narw.indiv[[prj]])[3], size = 1, prob = ps) * (narw.indiv[[prj]][i-1, &quot;age&quot;, ] &amp;lt;=69)
      narw.indiv[[prj]][i, &quot;alive&quot;, ] &amp;lt;- alive      # Sex remains the same
      narw.indiv[[prj]][i, &quot;female&quot;, ] &amp;lt;- narw.indiv[[prj]][i-1, &quot;female&quot;, ]      #' ----------------------------
      # GROWTH
      #' ----------------------------      # Increment age
      narw.indiv[[prj]][i, &quot;age&quot;, ] &amp;lt;- alive * narw.indiv[[prj]][i-1, &quot;age&quot;, ] + 1      # Increment length
      narw.indiv[[prj]][i,&quot;length&quot;, ] &amp;lt;- alive * age2length_vec(narw.indiv[[prj]][i, &quot;age&quot;, ],
                                                                t(narw.indiv[[prj]][i, c(&quot;length_a&quot;, &quot;length_b&quot;, &quot;length_c&quot;),]))      # Increment lean mass
      narw.indiv[[prj]][i,&quot;lean_mass&quot;, ] &amp;lt;- alive * length2mass_vec(narw.indiv[[prj]][i, &quot;length&quot;, ],
                                                                    t(narw.indiv[[prj]][i, c(&quot;mass_a&quot;, &quot;mass_b&quot;),]), lean = TRUE)      # Predict new body condition from current body condition
      narw.indiv[[prj]][i, &quot;bc&quot;, ] &amp;lt;- alive * predict_m(model = mod, cohort = current.dat[&quot;cohort&quot;,],
                                                        values = current.dat[&quot;bc&quot;,], prediction = &quot;bc&quot;)      # Increment total mass
      narw.indiv[[prj]][i,&quot;tot_mass&quot;, ] &amp;lt;- alive * narw.indiv[[prj]][i,&quot;lean_mass&quot;, ] / (1 - narw.indiv[[prj]][i,&quot;bc&quot;, ])      #' ----------------------------
      # REPRODUCTION
      #' ----------------------------      narw.indiv[[prj]][i, &quot;calving_int&quot;, ] &amp;lt;- alive * narw.indiv[[prj]][i-1, &quot;calving_int&quot;, ]
      narw.indiv[[prj]][i, &quot;t2calf&quot;, ] &amp;lt;- ifelse(narw.indiv[[prj]][i-1, &quot;t2calf&quot;, ] - 1 &amp;lt; 0, 0, narw.indiv[[prj]][i-1, &quot;t2calf&quot;, ] - 1)      # Minimum body condition needed to successfully bring fetus to term without starving
      # No evidence of reproductive senescence in right whales - Hamilton et al. (1998)
      narw.indiv[[prj]][i, &quot;min_bc&quot;, ] &amp;lt;- alive * predict_m(model = mod, values = narw.indiv[[prj]][i, &quot;tot_mass&quot;, ], 
                                                            prediction = &quot;gest&quot;) * (narw.indiv[[prj]][i-1, &quot;cohort&quot;, ] == 6)      # Birth of new calf
      narw.indiv[[prj]][i, &quot;birth&quot;, ] &amp;lt;- alive * (narw.indiv[[prj]][i, &quot;bc&quot;, ] &amp;gt;= narw.indiv[[prj]][i, &quot;min_bc&quot;, ]) * 
        (narw.indiv[[prj]][i-1, &quot;cohort&quot;, ] == 6) * (narw.indiv[[prj]][i-1, &quot;birth&quot;, ] == 0)      # Maturity - transitions between cohorts
      narw.indiv[[prj]][i, &quot;cohort&quot;, ] &amp;lt;- alive * increment_cohort(cohort = narw.indiv[[prj]][i-1, &quot;cohort&quot;, ],
                                                                   age = narw.indiv[[prj]][i, &quot;age&quot;, ],
                                                                   female = narw.indiv[[prj]][i, &quot;female&quot;, ],
                                                                   t2calf = narw.indiv[[prj]][i, &quot;t2calf&quot;, ])      # New births
      # narw.indiv[[prj]] &amp;lt;- new_calf(narw.indiv[[prj]][,,], year = i, attrib = mat.attribs)      # Number of animals in each cohort
      # Calves (male)
      narw.pop[prj, i, 1] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 0) *
                                   (narw.indiv[[prj]][i, &quot;female&quot;, ] == 0) *
                                   (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))      # Juveniles and adults (male)
      narw.pop[prj, i, 2] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 1) * (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))
      narw.pop[prj, i, 3] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 3) * (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))      # Calves (female)
      narw.pop[prj, i, 4] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 0) *
                                   (narw.indiv[[prj]][i, &quot;female&quot;, ] == 1) *
                                   (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))      # Juvenile and reproductive adults (female)
      narw.pop[prj, i, 5] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 2) * (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))
      narw.pop[prj, i, 6] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 4) * (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))
      narw.pop[prj, i, 7] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 5) * (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))
      narw.pop[prj, i, 8] &amp;lt;- sum((narw.indiv[[prj]][i, &quot;cohort&quot;, ] == 6) * (narw.indiv[[prj]][i, &quot;alive&quot;, ] == 1))      # Total population size
      tot.pop[prj, i] &amp;lt;- sum(narw.indiv[[prj]][i, &quot;alive&quot;, ], na.rm = TRUE)     # End years
   # End projections  # Compile outputs
  narw.df &amp;lt;- purrr::map(.x = cohorts$name, .f = ~
    narw.pop[,,.x] |&amp;gt; 
      tibble::as_tibble() |&amp;gt; 
      tibble::rownames_to_column(var = &quot;prj&quot;) |&amp;gt; 
      tidyr::pivot_longer(!prj, names_to = &quot;year&quot;, values_to = &quot;N&quot;) |&amp;gt; 
      dplyr::mutate(year = current.yr + as.numeric(gsub(&quot;yr &quot;, &quot;&quot;, year))) |&amp;gt; 
      dplyr::mutate(cohort = stringr::str_to_sentence(.x))
  ) |&amp;gt; do.call(what = rbind) |&amp;gt; data.table::data.table()  tot.df &amp;lt;- tibble::as_tibble(tot.pop) |&amp;gt; 
    tibble::rownames_to_column(var = &quot;prj&quot;) |&amp;gt; 
    tidyr::pivot_longer(!prj, names_to = &quot;year&quot;, values_to = &quot;N&quot;) |&amp;gt; 
    dplyr::mutate(year = current.yr + as.numeric(gsub(&quot;yr &quot;, &quot;&quot;, year))) |&amp;gt; 
    dplyr::mutate(cohort = &quot;North Atlantic right whales&quot;) |&amp;gt; data.table::data.table()  narw.conf &amp;lt;- narw.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)] |&amp;gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c(&quot;Calves (male)&quot;,
                                                     &quot;Calves (female)&quot;,
                                                     &quot;Juveniles (male)&quot;, 
                                                     &quot;Juveniles (female)&quot;, 
                                                     &quot;Adults (male)&quot;,
                                                     &quot;Adults (female, pregnant)&quot;,
                                                     &quot;Adults (female, lactating)&quot;,
                                                     &quot;Adults (female, resting)&quot;)))  tot.conf &amp;lt;- tot.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)]|&amp;gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c(&quot;Calves (male)&quot;,
                                                     &quot;Calves (female)&quot;,
                                                     &quot;Juveniles (male)&quot;, 
                                                     &quot;Juveniles (female)&quot;, 
                                                     &quot;Adults (male)&quot;,
                                                     &quot;Adults (female, pregnant)&quot;,
                                                     &quot;Adults (female, lactating)&quot;,
                                                     &quot;Adults (female, resting)&quot;,
                                                     &quot;North Atlantic right whales&quot;)))  p1 &amp;lt;- plot_projection(narw.df, narw.conf)
  p2 &amp;lt;- plot_projection(tot.df, tot.conf)  print(p1)
  print(p2)  # Find 95
  cat(&quot;Final population size:&quot;)
  final.pop &amp;lt;- unname(tot.df[year == current.yr + yrs,  quantile(N, probs = c(0.5, 0.025, 0.975))])
  cat(&quot;N = &quot;, final.pop[1], &quot; (95  return(list(ind = narw.indiv, df = rbind(narw.df, tot.df), ci = rbind(narw.conf, tot.conf)))
----------------------------"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">narwind</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/narwind.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/narw_density.html">NARW density in Canada</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>predictnarwsim &lt;- function(obj,
                            yrs = 35,
                            n = 100) 
  
  # if(is.null(obj$gam)) stop("Insufficient data available. Cannot proceed with population projections.")
  # if(!identical(cohortID, 1:6)) stop("Missing cohorts in input &lt;obj&gt;. Cannot proceed with population projections.")
  # if(length(obj$gam$fit$surv$xlevels[[1]]) &lt; 6 | length(obj$gam$fit$bc$xlevels[[1]]) &lt; 6) stop("Missing factor levels in input &lt;obj&gt;. Cannot proceed with population projections.")
  
  # plogis("link" predictions + error)
  
  # Adapted from original code by Scott Creel
  # https://www.montana.edu/screel/teaching/bioe-440r-521/course-outline/stoch_projection_new.R
  # 
  # Prediction intervals
  # https://stat.ethz.ch/pipermail/r-help/2011-April/275632.html
  
  # Population estimate as per 2022 NARW report card is 340 (+/- 7).
  
  # test &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = seq(0,0.6, 0.01)), type = "link", se.fit = TRUE)
  # plot(seq(0,0.6, 0.01), plogis(test$fit), type = "l")
  # lines(seq(0,0.6, 0.01), plogis(Reduce("+", test)), lty = 2)
  # lines(seq(0,0.6, 0.01), plogis(Reduce("-", test)), lty = 2)
  # test2 &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = 0.2), type = "response")
  # abline(v = 0.2)
  # abline(h = tesct2)
  
  cohortID &lt;- obj$param$cohortID
  cohorts &lt;- obj$param$cohorts |&gt; dplyr::slice(1) |&gt; 
    dplyr::mutate(name = gsub(", female", "", name), abb = gsub(",f", "", abb)) |&gt; 
    dplyr::bind_rows(obj$param$cohorts) |&gt; 
    dplyr::mutate(name = gsub("male, female", "female", name), abb = gsub("m,f", "f", abb))
  cohorts &lt;- cohorts[c(1,3,5,2,4,6,7,8)]
  
  # Attributes to monitor during projection
  mat.attribs &lt;- c("alive", "cohort", "female", "age", "length", "length_a", "length_b", "length_c",
                   "tot_mass", "lean_mass", "bc", "mass_a", "mass_b", "p_surv", "min_bc", "calving_int", "t2calf", "birth")
  
  # Current year
  current.yr &lt;- lubridate::year(lubridate::now())
  
  # Extract terminal functions
  mod &lt;- obj$gam$fit
  mod[["gest"]] &lt;- gam_gest
  
  #'------------------------------------------------------
  # INITIALIZATION
  #'------------------------------------------------------
  
  # Define initial population vector
  N0 &lt;- c(2, 5, 212, 2, 69, 1, 7, 61)
  names(N0) &lt;- cohorts[, name]
  
  # Create matrices and initialize them
  # rows: years &lt;yrs&gt;
  # columns: &lt;attributes&gt;
  # layers: individuals &lt;n&gt;
  # 4th dimension: replicate projection -&gt; later converted to list
  narw.indiv &lt;- array(data = NA, c(yrs + 1, length(mat.attribs), sum(N0), n), 
                      dimnames = list(paste0("yr ", 0:yrs), 
                                      mat.attribs,
                                      paste0("whale ", 1:sum(N0)),
                                      paste0("prj ", 1:n)))
  
  cohort.vec &lt;- do.call(c, sapply(X = 1:nrow(cohorts), FUN = function(x) rep(cohorts$id[x], each = N0[x])))
  
  # Alive and population cohort
  narw.indiv[1,"alive",,] &lt;- 1
  narw.indiv[1,"cohort",,] &lt;- rep(cohort.vec, n)
  
  # Sex
  #  -- Calves (male)
  narw.indiv[,"female", 1:N0[1], ] &lt;- 0  
  #  -- Calves (female)
  fem &lt;- which(cohort.vec == 0)
  narw.indiv[,"female", fem[fem &gt; N0[1]], ] &lt;- 1   
  #  -- Juveniles and adults
  narw.indiv[,"female", which(cohort.vec <!-- %in% c(2,4,5,6)), ] &lt;- 1 -->
  narw.indiv[,"female", which(cohort.vec <!-- %in% c(1,3)), ] &lt;- 0 -->
  
  # Age
  ages &lt;- start_age_vec(rep(cohort.vec, n))
  narw.indiv[1,"age", , ] &lt;- ages
  
  # Total body length
  l.params &lt;- agL_vec(ages)
  lengths &lt;- age2length_vec(ages, l.params)
  narw.indiv[1,"length", , ] &lt;- lengths
  narw.indiv[,"length_a",,] &lt;- rep(l.params[,1], each = yrs + 1)
  narw.indiv[,"length_b",,] &lt;- rep(l.params[,2], each = yrs + 1)
  narw.indiv[,"length_c",,] &lt;- rep(l.params[,3], each = yrs + 1)
  
  # Total mass
  m.params &lt;- mL(n*sum(N0))
  mass &lt;- length2mass_vec(lengths, m.params, FALSE)
  narw.indiv[,"mass_a",,] &lt;- rep(m.params[,1], each = yrs + 1)
  narw.indiv[,"mass_b",,] &lt;- rep(m.params[,2], each = yrs + 1)
  narw.indiv[1,"tot_mass", , ] &lt;- mass
  
  # Body conditon
  narw.indiv[1,"bc",,] &lt;- start_bcondition_vec(rep(cohort.vec, n))
  
  # lean mass
  narw.indiv[1,"lean_mass", , ] &lt;- mass - (narw.indiv[1,"bc",,] * mass)
  
  # Calving interval - mean of 5.3 years, up to apparent gaps of 13 years (Kraus et al. 2001)
  # NARWC Report Card 2022: Average inter-birth interval of 7.7 yrs, median of 8, min/max (2/13)
  # This corresponds to a Normal (7.7, 1.45)
  # Mean age at first calving = 9.53 +/- 2.32 (Kraus et al. 2001)
  # 
  # Stewart et al. 2022 -- 
  # The degree to which the energetic reserves of females are depleted during lactation may govern
  # the length of the resting period between successful pregnancies (Miller et al. 2011, Marón et al. 2015).
  narw.indiv[1,"calving_int",,] &lt;- (rep(cohort.vec, n) == 6) * rnorm(sum(N0)*n, mean = 7.7, sd = 1.45)
  narw.indiv[1,"t2calf",,] &lt;- round(narw.indiv[1,"calving_int",,],0)
  
  narw.indiv[1,"min_bc",,] &lt;- predict_m(model = mod,
                                        values = as.vector(narw.indiv[1,"tot_mass",,]), 
                                        prediction = "gest") * as.vector(narw.indiv[1, "cohort",, ] == 6)
  narw.indiv[1,"birth",,] &lt;- 0
  narw.indiv[1,"p_surv",,] &lt;- 1
  
  #' ---------------------------
  # IMPORTANT 
  #' ---------------------------
  # Turn array into a list - otherwise cannot add new calves within projections
  narw.indiv &lt;- purrr::array_branch(narw.indiv, 4) 
  
  # Number of individuals in each cohort
  narw.pop &lt;- array(data = NA, c(n, yrs + 1, length(N0)), 
                    dimnames = list(paste0("prj ", 1:n),
                                    paste0("yr ", 0:yrs), 
                                    cohorts$name))
  narw.pop[,1,] &lt;- rep(N0, each = n)
  
  # Total population size
  tot.pop &lt;- matrix(0, n, yrs + 1, dimnames = list(paste0("prj",1:n), paste0("yr ", 0:yrs)))
  tot.pop[,1] &lt;- sum(N0)
  
  #'------------------------------------------------------
  # RUN PROJECTIONS
  #'------------------------------------------------------
  
  # This uses nested loops. 
  # The prj loop (outermost loop) replicates the projection &lt;n&gt; times.
  # The i loop is next, and steps across all years of projection from an initial population vector.
  
  # Set up progress bar
  pb &lt;- progress::progress_bar$new(
    format = "[:bar] :percent eta: :eta",
    total = n, clear = FALSE, width = 80
  )
  
  for(prj in 1:n)
    
    pb$tick() # Update progress bar
    
    #'------------------------------------------------------
    # Loop over years
    #'------------------------------------------------------
    
    for(i in 2:(yrs+1))
      
      current.dat &lt;- as.matrix(narw.indiv[[prj]][i-1, , ])
      alive &lt;- narw.indiv[[prj]][i-1, "alive", ]
      
      #' ----------------------------
      # SURVIVAL
      #' ----------------------------
      # Predict survival probability based on body condition
      ps &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",], values = current.dat["bc",], prediction = "surv")
      narw.indiv[[prj]][i, "p_surv", ] &lt;- ps
      
      # Determine whether the animal survived
      # Maximum longevity of 69 years
      alive &lt;- rbinom(n = dim(narw.indiv[[prj]])[3], size = 1, prob = ps) * (narw.indiv[[prj]][i-1, "age", ] &lt;=69)
      narw.indiv[[prj]][i, "alive", ] &lt;- alive
      
      # Sex remains the same
      narw.indiv[[prj]][i, "female", ] &lt;- narw.indiv[[prj]][i-1, "female", ]
      
      #' ----------------------------
      # GROWTH
      #' ----------------------------
      
      # Increment age
      narw.indiv[[prj]][i, "age", ] &lt;- alive * narw.indiv[[prj]][i-1, "age", ] + 1
      
      # Increment length
      narw.indiv[[prj]][i,"length", ] &lt;- alive * age2length_vec(narw.indiv[[prj]][i, "age", ],
                                                                t(narw.indiv[[prj]][i, c("length_a", "length_b", "length_c"),]))
      
      # Increment lean mass
      narw.indiv[[prj]][i,"lean_mass", ] &lt;- alive * length2mass_vec(narw.indiv[[prj]][i, "length", ],
                                                                    t(narw.indiv[[prj]][i, c("mass_a", "mass_b"),]), lean = TRUE)
      
      # Predict new body condition from current body condition
      narw.indiv[[prj]][i, "bc", ] &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",],
                                                        values = current.dat["bc",], prediction = "bc")
      
      # Increment total mass
      narw.indiv[[prj]][i,"tot_mass", ] &lt;- alive * narw.indiv[[prj]][i,"lean_mass", ] / (1 - narw.indiv[[prj]][i,"bc", ])
      
      #' ----------------------------
      # REPRODUCTION
      #' ----------------------------
      
      narw.indiv[[prj]][i, "calving_int", ] &lt;- alive * narw.indiv[[prj]][i-1, "calving_int", ]
      narw.indiv[[prj]][i, "t2calf", ] &lt;- ifelse(narw.indiv[[prj]][i-1, "t2calf", ] - 1 &lt; 0, 0, narw.indiv[[prj]][i-1, "t2calf", ] - 1)
      
      # Minimum body condition needed to successfully bring fetus to term without starving
      # No evidence of reproductive senescence in right whales - Hamilton et al. (1998)
      narw.indiv[[prj]][i, "min_bc", ] &lt;- alive * predict_m(model = mod, values = narw.indiv[[prj]][i, "tot_mass", ], 
                                                            prediction = "gest") * (narw.indiv[[prj]][i-1, "cohort", ] == 6)
      
      # Birth of new calf
      narw.indiv[[prj]][i, "birth", ] &lt;- alive * (narw.indiv[[prj]][i, "bc", ] &gt;= narw.indiv[[prj]][i, "min_bc", ]) * 
        (narw.indiv[[prj]][i-1, "cohort", ] == 6) * (narw.indiv[[prj]][i-1, "birth", ] == 0)
      
      # Maturity - transitions between cohorts
      narw.indiv[[prj]][i, "cohort", ] &lt;- alive * increment_cohort(cohort = narw.indiv[[prj]][i-1, "cohort", ],
                                                                   age = narw.indiv[[prj]][i, "age", ],
                                                                   female = narw.indiv[[prj]][i, "female", ],
                                                                   t2calf = narw.indiv[[prj]][i, "t2calf", ])
      
      # New births
      # narw.indiv[[prj]] &lt;- new_calf(narw.indiv[[prj]][,,], year = i, attrib = mat.attribs)
      
      # Number of animals in each cohort
      # Calves (male)
      narw.pop[prj, i, 1] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 0) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Juveniles and adults (male)
      narw.pop[prj, i, 2] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 1) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 3] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 3) * (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Calves (female)
      narw.pop[prj, i, 4] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 1) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Juvenile and reproductive adults (female)
      narw.pop[prj, i, 5] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 2) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 6] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 4) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 7] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 5) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 8] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 6) * (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Total population size
      tot.pop[prj, i] &lt;- sum(narw.indiv[[prj]][i, "alive", ], na.rm = TRUE)
      
     # End years
   # End projections
  
  # Compile outputs
  narw.df &lt;- purrr::map(.x = cohorts$name, .f = ~
    narw.pop[,,.x] |&gt; 
      tibble::as_tibble() |&gt; 
      tibble::rownames_to_column(var = "prj") |&gt; 
      tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
      dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
      dplyr::mutate(cohort = stringr::str_to_sentence(.x))
  ) |&gt; do.call(what = rbind) |&gt; data.table::data.table()
  
  tot.df &lt;- tibble::as_tibble(tot.pop) |&gt; 
    tibble::rownames_to_column(var = "prj") |&gt; 
    tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
    dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
    dplyr::mutate(cohort = "North Atlantic right whales") |&gt; data.table::data.table()
  
  narw.conf &lt;- narw.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)] |&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)")))
  
  tot.conf &lt;- tot.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)]|&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)",
                                                     "North Atlantic right whales")))
  
  p1 &lt;- plot_projection(narw.df, narw.conf)
  p2 &lt;- plot_projection(tot.df, tot.conf)
  
  print(p1)
  print(p2)
  
  # Find 95<!-- % confidence intervals on final population size -->
  cat("Final population size:")
  final.pop &lt;- unname(tot.df[year == current.yr + yrs,  quantile(N, probs = c(0.5, 0.025, 0.975))])
  cat("N = ", final.pop[1], " (95<!-- % CI: ", final.pop[2], "–", final.pop[3], ")\n", sep = "") -->
  
  return(list(ind = narw.indiv, df = rbind(narw.df, tot.df), ci = rbind(narw.conf, tot.conf)))
  

----------------------------</h1>
    
    <div class="hidden name"><code>predict_leslie.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>predictnarwsim &lt;- function(obj,
                            yrs = 35,
                            n = 100)   # if(is.null(obj$gam)) stop("Insufficient data available. Cannot proceed with population projections.")
  # if(!identical(cohortID, 1:6)) stop("Missing cohorts in input &lt;obj&gt;. Cannot proceed with population projections.")
  # if(length(obj$gam$fit$surv$xlevels[[1]]) &lt; 6 | length(obj$gam$fit$bc$xlevels[[1]]) &lt; 6) stop("Missing factor levels in input &lt;obj&gt;. Cannot proceed with population projections.")  # plogis("link" predictions + error)  # Adapted from original code by Scott Creel
  # https://www.montana.edu/screel/teaching/bioe-440r-521/course-outline/stoch_projection_new.R
  # 
  # Prediction intervals
  # https://stat.ethz.ch/pipermail/r-help/2011-April/275632.html  # Population estimate as per 2022 NARW report card is 340 (+/- 7).  # test &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = seq(0,0.6, 0.01)), type = "link", se.fit = TRUE)
  # plot(seq(0,0.6, 0.01), plogis(test$fit), type = "l")
  # lines(seq(0,0.6, 0.01), plogis(Reduce("+", test)), lty = 2)
  # lines(seq(0,0.6, 0.01), plogis(Reduce("-", test)), lty = 2)
  # test2 &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = 0.2), type = "response")
  # abline(v = 0.2)
  # abline(h = tesct2)  cohortID &lt;- obj$param$cohortID
  cohorts &lt;- obj$param$cohorts |&gt; dplyr::slice(1) |&gt; 
    dplyr::mutate(name = gsub(", female", "", name), abb = gsub(",f", "", abb)) |&gt; 
    dplyr::bind_rows(obj$param$cohorts) |&gt; 
    dplyr::mutate(name = gsub("male, female", "female", name), abb = gsub("m,f", "f", abb))
  cohorts &lt;- cohorts[c(1,3,5,2,4,6,7,8)]  # Attributes to monitor during projection
  mat.attribs &lt;- c("alive", "cohort", "female", "age", "length", "length_a", "length_b", "length_c",
                   "tot_mass", "lean_mass", "bc", "mass_a", "mass_b", "p_surv", "min_bc", "calving_int", "t2calf", "birth")  # Current year
  current.yr &lt;- lubridate::year(lubridate::now())  # Extract terminal functions
  mod &lt;- obj$gam$fit
  mod[["gest"]] &lt;- gam_gest  #'------------------------------------------------------
  # INITIALIZATION
  #'------------------------------------------------------  # Define initial population vector
  N0 &lt;- c(2, 5, 212, 2, 69, 1, 7, 61)
  names(N0) &lt;- cohorts[, name]  # Create matrices and initialize them
  # rows: years &lt;yrs&gt;
  # columns: &lt;attributes&gt;
  # layers: individuals &lt;n&gt;
  # 4th dimension: replicate projection -&gt; later converted to list
  narw.indiv &lt;- array(data = NA, c(yrs + 1, length(mat.attribs), sum(N0), n), 
                      dimnames = list(paste0("yr ", 0:yrs), 
                                      mat.attribs,
                                      paste0("whale ", 1:sum(N0)),
                                      paste0("prj ", 1:n)))  cohort.vec &lt;- do.call(c, sapply(X = 1:nrow(cohorts), FUN = function(x) rep(cohorts$id[x], each = N0[x])))  # Alive and population cohort
  narw.indiv[1,"alive",,] &lt;- 1
  narw.indiv[1,"cohort",,] &lt;- rep(cohort.vec, n)  # Sex
  #  -- Calves (male)
  narw.indiv[,"female", 1:N0[1], ] &lt;- 0  
  #  -- Calves (female)
  fem &lt;- which(cohort.vec == 0)
  narw.indiv[,"female", fem[fem &gt; N0[1]], ] &lt;- 1   
  #  -- Juveniles and adults
  narw.indiv[,"female", which(cohort.vec <!-- %in% c(2,4,5,6)), ] &lt;- 1 -->
  narw.indiv[,"female", which(cohort.vec <!-- %in% c(1,3)), ] &lt;- 0 -->  # Age
  ages &lt;- start_age_vec(rep(cohort.vec, n))
  narw.indiv[1,"age", , ] &lt;- ages  # Total body length
  l.params &lt;- agL_vec(ages)
  lengths &lt;- age2length_vec(ages, l.params)
  narw.indiv[1,"length", , ] &lt;- lengths
  narw.indiv[,"length_a",,] &lt;- rep(l.params[,1], each = yrs + 1)
  narw.indiv[,"length_b",,] &lt;- rep(l.params[,2], each = yrs + 1)
  narw.indiv[,"length_c",,] &lt;- rep(l.params[,3], each = yrs + 1)  # Total mass
  m.params &lt;- mL(n*sum(N0))
  mass &lt;- length2mass_vec(lengths, m.params, FALSE)
  narw.indiv[,"mass_a",,] &lt;- rep(m.params[,1], each = yrs + 1)
  narw.indiv[,"mass_b",,] &lt;- rep(m.params[,2], each = yrs + 1)
  narw.indiv[1,"tot_mass", , ] &lt;- mass  # Body conditon
  narw.indiv[1,"bc",,] &lt;- start_bcondition_vec(rep(cohort.vec, n))  # lean mass
  narw.indiv[1,"lean_mass", , ] &lt;- mass - (narw.indiv[1,"bc",,] * mass)  # Calving interval - mean of 5.3 years, up to apparent gaps of 13 years (Kraus et al. 2001)
  # NARWC Report Card 2022: Average inter-birth interval of 7.7 yrs, median of 8, min/max (2/13)
  # This corresponds to a Normal (7.7, 1.45)
  # Mean age at first calving = 9.53 +/- 2.32 (Kraus et al. 2001)
  # 
  # Stewart et al. 2022 -- 
  # The degree to which the energetic reserves of females are depleted during lactation may govern
  # the length of the resting period between successful pregnancies (Miller et al. 2011, Marón et al. 2015).
  narw.indiv[1,"calving_int",,] &lt;- (rep(cohort.vec, n) == 6) * rnorm(sum(N0)*n, mean = 7.7, sd = 1.45)
  narw.indiv[1,"t2calf",,] &lt;- round(narw.indiv[1,"calving_int",,],0)  narw.indiv[1,"min_bc",,] &lt;- predict_m(model = mod,
                                        values = as.vector(narw.indiv[1,"tot_mass",,]), 
                                        prediction = "gest") * as.vector(narw.indiv[1, "cohort",, ] == 6)
  narw.indiv[1,"birth",,] &lt;- 0
  narw.indiv[1,"p_surv",,] &lt;- 1  #' ---------------------------
  # IMPORTANT 
  #' ---------------------------
  # Turn array into a list - otherwise cannot add new calves within projections
  narw.indiv &lt;- purrr::array_branch(narw.indiv, 4)   # Number of individuals in each cohort
  narw.pop &lt;- array(data = NA, c(n, yrs + 1, length(N0)), 
                    dimnames = list(paste0("prj ", 1:n),
                                    paste0("yr ", 0:yrs), 
                                    cohorts$name))
  narw.pop[,1,] &lt;- rep(N0, each = n)  # Total population size
  tot.pop &lt;- matrix(0, n, yrs + 1, dimnames = list(paste0("prj",1:n), paste0("yr ", 0:yrs)))
  tot.pop[,1] &lt;- sum(N0)  #'------------------------------------------------------
  # RUN PROJECTIONS
  #'------------------------------------------------------  # This uses nested loops. 
  # The prj loop (outermost loop) replicates the projection &lt;n&gt; times.
  # The i loop is next, and steps across all years of projection from an initial population vector.  # Set up progress bar
  pb &lt;- progress::progress_bar$new(
    format = "[:bar] :percent eta: :eta",
    total = n, clear = FALSE, width = 80
  )  for(prj in 1:n)    pb$tick() # Update progress bar    #'------------------------------------------------------
    # Loop over years
    #'------------------------------------------------------    for(i in 2:(yrs+1))      current.dat &lt;- as.matrix(narw.indiv[[prj]][i-1, , ])
      alive &lt;- narw.indiv[[prj]][i-1, "alive", ]      #' ----------------------------
      # SURVIVAL
      #' ----------------------------
      # Predict survival probability based on body condition
      ps &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",], values = current.dat["bc",], prediction = "surv")
      narw.indiv[[prj]][i, "p_surv", ] &lt;- ps      # Determine whether the animal survived
      # Maximum longevity of 69 years
      alive &lt;- rbinom(n = dim(narw.indiv[[prj]])[3], size = 1, prob = ps) * (narw.indiv[[prj]][i-1, "age", ] &lt;=69)
      narw.indiv[[prj]][i, "alive", ] &lt;- alive      # Sex remains the same
      narw.indiv[[prj]][i, "female", ] &lt;- narw.indiv[[prj]][i-1, "female", ]      #' ----------------------------
      # GROWTH
      #' ----------------------------      # Increment age
      narw.indiv[[prj]][i, "age", ] &lt;- alive * narw.indiv[[prj]][i-1, "age", ] + 1      # Increment length
      narw.indiv[[prj]][i,"length", ] &lt;- alive * age2length_vec(narw.indiv[[prj]][i, "age", ],
                                                                t(narw.indiv[[prj]][i, c("length_a", "length_b", "length_c"),]))      # Increment lean mass
      narw.indiv[[prj]][i,"lean_mass", ] &lt;- alive * length2mass_vec(narw.indiv[[prj]][i, "length", ],
                                                                    t(narw.indiv[[prj]][i, c("mass_a", "mass_b"),]), lean = TRUE)      # Predict new body condition from current body condition
      narw.indiv[[prj]][i, "bc", ] &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",],
                                                        values = current.dat["bc",], prediction = "bc")      # Increment total mass
      narw.indiv[[prj]][i,"tot_mass", ] &lt;- alive * narw.indiv[[prj]][i,"lean_mass", ] / (1 - narw.indiv[[prj]][i,"bc", ])      #' ----------------------------
      # REPRODUCTION
      #' ----------------------------      narw.indiv[[prj]][i, "calving_int", ] &lt;- alive * narw.indiv[[prj]][i-1, "calving_int", ]
      narw.indiv[[prj]][i, "t2calf", ] &lt;- ifelse(narw.indiv[[prj]][i-1, "t2calf", ] - 1 &lt; 0, 0, narw.indiv[[prj]][i-1, "t2calf", ] - 1)      # Minimum body condition needed to successfully bring fetus to term without starving
      # No evidence of reproductive senescence in right whales - Hamilton et al. (1998)
      narw.indiv[[prj]][i, "min_bc", ] &lt;- alive * predict_m(model = mod, values = narw.indiv[[prj]][i, "tot_mass", ], 
                                                            prediction = "gest") * (narw.indiv[[prj]][i-1, "cohort", ] == 6)      # Birth of new calf
      narw.indiv[[prj]][i, "birth", ] &lt;- alive * (narw.indiv[[prj]][i, "bc", ] &gt;= narw.indiv[[prj]][i, "min_bc", ]) * 
        (narw.indiv[[prj]][i-1, "cohort", ] == 6) * (narw.indiv[[prj]][i-1, "birth", ] == 0)      # Maturity - transitions between cohorts
      narw.indiv[[prj]][i, "cohort", ] &lt;- alive * increment_cohort(cohort = narw.indiv[[prj]][i-1, "cohort", ],
                                                                   age = narw.indiv[[prj]][i, "age", ],
                                                                   female = narw.indiv[[prj]][i, "female", ],
                                                                   t2calf = narw.indiv[[prj]][i, "t2calf", ])      # New births
      # narw.indiv[[prj]] &lt;- new_calf(narw.indiv[[prj]][,,], year = i, attrib = mat.attribs)      # Number of animals in each cohort
      # Calves (male)
      narw.pop[prj, i, 1] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 0) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))      # Juveniles and adults (male)
      narw.pop[prj, i, 2] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 1) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 3] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 3) * (narw.indiv[[prj]][i, "alive", ] == 1))      # Calves (female)
      narw.pop[prj, i, 4] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 1) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))      # Juvenile and reproductive adults (female)
      narw.pop[prj, i, 5] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 2) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 6] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 4) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 7] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 5) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 8] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 6) * (narw.indiv[[prj]][i, "alive", ] == 1))      # Total population size
      tot.pop[prj, i] &lt;- sum(narw.indiv[[prj]][i, "alive", ], na.rm = TRUE)     # End years
   # End projections  # Compile outputs
  narw.df &lt;- purrr::map(.x = cohorts$name, .f = ~
    narw.pop[,,.x] |&gt; 
      tibble::as_tibble() |&gt; 
      tibble::rownames_to_column(var = "prj") |&gt; 
      tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
      dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
      dplyr::mutate(cohort = stringr::str_to_sentence(.x))
  ) |&gt; do.call(what = rbind) |&gt; data.table::data.table()  tot.df &lt;- tibble::as_tibble(tot.pop) |&gt; 
    tibble::rownames_to_column(var = "prj") |&gt; 
    tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
    dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
    dplyr::mutate(cohort = "North Atlantic right whales") |&gt; data.table::data.table()  narw.conf &lt;- narw.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)] |&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)")))  tot.conf &lt;- tot.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)]|&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)",
                                                     "North Atlantic right whales")))  p1 &lt;- plot_projection(narw.df, narw.conf)
  p2 &lt;- plot_projection(tot.df, tot.conf)  print(p1)
  print(p2)  # Find 95<!-- % confidence intervals on final population size -->
  cat("Final population size:")
  final.pop &lt;- unname(tot.df[year == current.yr + yrs,  quantile(N, probs = c(0.5, 0.025, 0.975))])
  cat("N = ", final.pop[1], " (95<!-- % CI: ", final.pop[2], "–", final.pop[3], ")\n", sep = "") -->  return(list(ind = narw.indiv, df = rbind(narw.df, tot.df), ci = rbind(narw.conf, tot.conf)))
----------------------------</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">predict_leslie</span><span class="op">(</span><span class="va">obj</span>, n <span class="op">=</span> <span class="fl">100</span>, yrs <span class="op">=</span> <span class="fl">35</span><span class="op">)</span></span></code></pre></div>
    </div>


  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Phil J. Bouchet.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

