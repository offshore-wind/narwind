<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Function reference • narwind</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Function reference"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-index">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">narwind</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/narwind.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/narw_density.html">NARW density in Canada</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>Reference</h1>
    </div>

    <table class="ref-index"><colgroup><col class="alias"><col class="title"></colgroup><tbody><tr><th colspan="2">
          <h2 id="all-functions">All functions <a href="#all-functions" class="anchor" aria-hidden="true"></a></h2>
          <p class="section-desc"></p>
        </th>
      </tr></tbody><tbody><tr><td>
          <p><code><a href="NARW_simulator.html">NARW_simulator()</a></code> </p>
        </td>
        <td><p>Simulate right whale movements</p></td>
      </tr><tr><td>
          <p><code><a href="RMR.html">RMR</a></code> </p>
        </td>
        <td><p>Resting metabolic rate</p></td>
      </tr><tr><td>
          <p><code><a href="age2length.html">age2length</a></code> </p>
        </td>
        <td><p>Age to length conversion</p></td>
      </tr><tr><td>
          <p><code><a href="alignmove.html">alignmove()</a></code> </p>
        </td>
        <td><p>Decrease in milk feeding efficiency as a function of calf age</p></td>
      </tr><tr><td>
          <p><code><a href="augment.narwsim.html">augment(<i>&lt;narwsim&gt;</i>)</a></code> </p>
        </td>
        <td><p>Posterior simulation from fitted survival and health GAMs</p></td>
      </tr><tr><td>
          <p><code><a href="clip_density.html">clip_density()</a></code> </p>
        </td>
        <td><p>Title</p></td>
      </tr><tr><td>
          <p><code><a href="create_gantt.html">create_gantt()</a></code> </p>
        </td>
        <td><p>Pile-driving schedule</p></td>
      </tr><tr><td>
          <p><code><a href="deg2radians.html">deg2radians()</a></code> </p>
        </td>
        <td><p>Convert degrees to radians</p></td>
      </tr><tr><td>
          <p><code><a href="density_narw.html">density_narw</a></code> </p>
        </td>
        <td><p>North Atlantic right whale density surfaces</p></td>
      </tr><tr><td>
          <p><code><a href="entanglement_event.html">entanglement_event()</a></code> </p>
        </td>
        <td><p>Entanglement event</p></td>
      </tr><tr><td>
          <p><code><a href="feeding_threshold.html">feeding_threshold()</a></code> </p>
        </td>
        <td><p>Incidence of foraging behavior</p></td>
      </tr><tr><td>
          <p><code><a href="feeding_threshold_vec.html">feeding_threshold_vec()</a></code> </p>
        </td>
        <td><p>Incidence of foraging behavior (vectorized)</p></td>
      </tr><tr><td>
          <p><code><a href="fetal_blubber_mass.html">fetal_blubber_mass()</a></code> <code><a href="fetal_blubber_mass.html">fetal_blubber_mass_vec()</a></code> </p>
        </td>
        <td><p>Fetal blubber mass</p></td>
      </tr><tr><td>
          <p><code><a href="fetal_length.html">fetal_length()</a></code> <code><a href="fetal_length.html">fetal_length_vec()</a></code> </p>
        </td>
        <td><p>Fetal length</p></td>
      </tr><tr><td>
          <p><code><a href="fetal_mass-open-paren-vectorised-close-paren.html">fetal_mass_vec()</a></code> </p>
        </td>
        <td><p>Fetal mass</p></td>
      </tr><tr><td>
          <p><code><a href="fetal_mass.html">fetal_mass()</a></code> </p>
        </td>
        <td><p>Fetal mass</p></td>
      </tr><tr><td>
          <p><code><a href="fetal_tissue_mass.html">fetal_tissue_mass()</a></code> <code><a href="fetal_tissue_mass.html">fetal_tissue_mass_vec()</a></code> </p>
        </td>
        <td><p>Fetal tissue mass</p></td>
      </tr><tr><td>
          <p><code><a href="fill_mask.html">fill_mask()</a></code> </p>
        </td>
        <td><p>Clip and fill input raster</p></td>
      </tr><tr><td>
          <p><code><a href="filtration_rate.html">filtration_rate</a></code> </p>
        </td>
        <td><p>Filtration rate</p></td>
      </tr><tr><td>
          <p><code><a href="find_mortality.html">find_mortality()</a></code> </p>
        </td>
        <td><p>Estimate daily p(dead) to match a target annual mortality rate</p></td>
      </tr><tr><td>
          <p><code><a href="gape_size.html">gape_size()</a></code> </p>
        </td>
        <td><p>Area of the gape</p></td>
      </tr><tr><td>
          <p><code><a href="get_ais.html">get_ais()</a></code> </p>
        </td>
        <td><p>Download density maps</p></td>
      </tr><tr><td>
          <p><code><a href="get_density.html">get_density()</a></code> </p>
        </td>
        <td><p>Download density maps</p></td>
      </tr><tr><td>
          <p><code><a href="get_farms.html">get_farms()</a></code> </p>
        </td>
        <td><p>Load wind farm shapefiles</p></td>
      </tr><tr><td>
          <p><code><a href="get_prey.html">get_prey()</a></code> </p>
        </td>
        <td><p>Prey surfaces</p></td>
      </tr><tr><td>
          <p><code><a href="growth_cost.html">growth_cost_old()</a></code> </p>
        </td>
        <td><p>Energetic cost of growth</p></td>
      </tr><tr><td>
          <p><code><a href="heat_gestation.html">heat_gestation()</a></code> <code><a href="heat_gestation.html">heat_gestation_vec()</a></code> </p>
        </td>
        <td><p>Heat increment of gestation</p></td>
      </tr><tr><td>
          <p><code><a href="locomotor_costs.html">locomotor_costs()</a></code> </p>
        </td>
        <td><p>Costs of locomotion</p></td>
      </tr><tr><td>
          <p><code><a href="mammary_mass.html">mammary_mass</a></code> </p>
        </td>
        <td><p>Total mass of mammary glands</p></td>
      </tr><tr><td>
          <p><code><a href="map_noise.html">map_noise()</a></code> </p>
        </td>
        <td><p>Noise levels</p></td>
      </tr><tr><td>
          <p><code><a href="map_vessels.html">map_vessels()</a></code> </p>
        </td>
        <td><p>Vessel strikes</p></td>
      </tr><tr><td>
          <p><code><a href="milk_assimilation.html">milk_assimilation</a></code> </p>
        </td>
        <td><p>Milk assimilation efficiency</p></td>
      </tr><tr><td>
          <p><code><a href="milk_ingestion.html">milk_ingestion</a></code> </p>
        </td>
        <td><p>Milk ingestion rate</p></td>
      </tr><tr><td>
          <p><code><a href="milk_production.html">milk_production</a></code> </p>
        </td>
        <td><p>Milk production rate</p></td>
      </tr><tr><td>
          <p><code><a href="milk_supply.html">milk_supply</a></code> </p>
        </td>
        <td><p>Milk provisioning</p></td>
      </tr><tr><td>
          <p><code><a href="narw.html">narw()</a></code> </p>
        </td>
        <td><p>Individual-based model of North Atlantic right whales</p></td>
      </tr><tr><td>
          <p><code><a href="narw_crs.html">narw_crs()</a></code> </p>
        </td>
        <td><p>Projected coordinate system</p></td>
      </tr><tr><td>
          <p><code><a href="narwind-package.html">narwind-package</a></code> <code><a href="narwind-package.html">narwind</a></code> </p>
        </td>
        <td><p>A short title line describing what the package does</p></td>
      </tr><tr><td>
          <p><code><a href="narwind.html">narwind</a></code> </p>
        </td>
        <td><p>Assessment of offshore wind impacts on North Atlantic right whales</p></td>
      </tr><tr><td>
          <p><code><a href="new_calf.html">new_calf()</a></code> </p>
        </td>
        <td><p>---------------------------</p></td>
      </tr><tr><td>
          <p><code><a href="placental_maintenance.html">placental_maintenance_vec()</a></code> <code><a href="placental_maintenance.html">placental_maintenance()</a></code> </p>
        </td>
        <td><p>Energetic cost of placental maintenance during pregnancy (vectorised)</p></td>
      </tr><tr><td>
          <p><code><a href="plot.narwproj.html">plot(<i>&lt;narwproj&gt;</i>)</a></code> </p>
        </td>
        <td><p>Plot population trends</p></td>
      </tr><tr><td>
          <p><code><a href="plot.narwsim.html">plot(<i>&lt;narwsim&gt;</i>)</a></code> </p>
        </td>
        <td><p>Model plots</p></td>
      </tr><tr><td>
          <p><code><a href="predict.narwsim.html">predict(<i>&lt;narwsim&gt;</i>)</a></code> </p>
        </td>
        <td><p>Predictions of right whale abundance</p></td>
      </tr><tr><td>
          <p><code><a href="predict_m.html">predict_m()</a></code> </p>
        </td>
        <td><p>predict_backup &lt;- function(obj,
         yrs = 35,
         n = 100,
         popr = 1,
         do.plot = FALSE,
         seed = 125897,
         ...) 
  
  set.seed(seed)
  
  if(sum(suppressWarnings(purrr::map_lgl(.x = obj$gam$pred, .f = ~any(is.na(.x)))) &gt; 0)) 
    stop("Insufficient sample size. Cannot make predictions.") 
  
  # Function ellipsis –– optional arguments
  args &lt;- list(...)
  
  # Default values
  if(length(args) == 0)
    spline &lt;- TRUE
    progress &lt;- TRUE
   else 
    if("spline" <!-- %in% names(args)) spline &lt;- args[["spline"]] else spline &lt;- TRUE -->
    if("progress" <!-- %in% names(args)) progress &lt;- args[["progress"]] else progress &lt;- TRUE -->
  
  
  cat("Initializing ...")
  
  # if(is.null(obj$gam)) stop("Insufficient data available. Cannot proceed with population projections.")
  # if(!identical(cohortID, 1:6)) stop("Missing cohorts in input &lt;obj&gt;. Cannot proceed with population projections.")
  # if(length(obj$gam$fit$surv$xlevels[[1]]) &lt; 6 | length(obj$gam$fit$bc$xlevels[[1]]) &lt; 6) stop("Missing factor levels in input &lt;obj&gt;. Cannot proceed with population projections.")
  
  # plogis("link" predictions + error)
  
  # Adapted from original code by Scott Creel
  # https://www.montana.edu/screel/teaching/bioe-440r-521/course-outline/stoch_projection_new.R
  # 
  # Prediction intervals
  # https://stat.ethz.ch/pipermail/r-help/2011-April/275632.html
  
  # Population estimate as per 2022 NARW report card is 340 (+/- 7).
  
  # test &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = seq(0, find_maxBC(), 0.01)), type = "link", se.fit = TRUE)
  # plot(seq(0,find_maxBC(), 0.01), plogis(test$fit), type = "l")
  # lines(seq(0, find_maxBC(), 0.01), plogis(Reduce("+", test)), lty = 2)
  # lines(seq(0, find_maxBC(), 0.01), plogis(Reduce("-", test)), lty = 2)
  # test2 &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = 0.2), type = "response")
  # abline(v = 0.2)
  # abline(h = tesct2)
  
  cohortID &lt;- obj$param$cohortID
  cohorts &lt;- obj$param$cohorts |&gt; dplyr::slice(1) |&gt; 
    dplyr::mutate(name = gsub(", female", "", name), abb = gsub(",f", "", abb)) |&gt; 
    dplyr::bind_rows(obj$param$cohorts) |&gt; 
    dplyr::mutate(name = gsub("male, female", "female", name), abb = gsub("m,f", "f", abb))
  cohorts &lt;- cohorts[c(1,3,5,2,4,6,7,8)]
  
  # Attributes to monitor during projection
  mat.attribs &lt;- c("alive", "cohort", "female", "age", "length", "length_a", "length_b", "length_c",
                   "tot_mass", "lean_mass", "bc", "mass_a", "mass_b", "p_surv", "min_bc", "trest", "t2calf", "birth")
  
  # Current year
  current.yr &lt;- lubridate::year(lubridate::now())
  
  # Extract terminal functions
  mod &lt;- obj$gam$fit
  mod[["gest"]] &lt;- gam_gest
  
  #'------------------------------------------------------
  # GAM PARAMETERS
  #'------------------------------------------------------
  
  mbc_preds &lt;- obj$gam$pred$bc_gest
  bc_preds &lt;- obj$gam$pred$bc
  surv_preds &lt;- obj$gam$pred$surv
  
  #'------------------------------------------------------
  # INITIALIZATION
  #'------------------------------------------------------
  
  # Define initial population vector
  # c(F1 = 0, F2 = 0, F3 = 2, F4 = 6, F5 = 4, F6 = 0, F7 = 6, F8 = 0, 
  # F9 = 5, "F10+" = 48, FC = 7, FR = 0, FB = 61, 
  # M1 = 0, M2 = 0, 
  # M3 = 2, M4 = 5, 
  # "M5+" = 212)
  N0 &lt;- c(0, 7, 212, 0, 71, 1, 7, 61)
  names(N0) &lt;- cohorts[, name]
  totn &lt;- sum(N0)* (1 + popr)
  
  cat("Setting up ...")
  
  # Create matrices and initialize them
  # rows: years &lt;yrs&gt;
  # columns: &lt;attributes&gt;
  # layers: individuals &lt;n&gt;
  # 4th dimension: replicate projection -&gt; later converted to list
  narw.indiv &lt;- array(data = NA, c(yrs + 1, length(mat.attribs), totn, n), 
                      dimnames = list(paste0("yr ", 0:yrs), 
                                      mat.attribs,
                                      paste0("whale ", 1:totn),
                                      paste0("prj ", 1:n)))
  
  cohort.vec &lt;- do.call(c, sapply(X = 1:nrow(cohorts), FUN = function(x) rep(cohorts$id[x], each = N0[x])))
  
  animals &lt;- 1:sum(N0)
  
  # Alive and population cohort
  narw.indiv[1, "alive", animals, ] &lt;- rep(1, )
  narw.indiv[1, "cohort", animals, ] &lt;- rep(cohort.vec, n)
  
  # Sex
  #  -- Calves (male)
  narw.indiv[, "female", 1:N0[1], ] &lt;- 0
  #  -- Calves (female)
  fem &lt;- which(cohort.vec == 0)
  narw.indiv[, "female", fem[fem &gt; N0[1]], ] &lt;- 1
  #  -- Juveniles and adults
  narw.indiv[, "female", which(cohort.vec <!-- %in% c(2, 4, 5, 6)), ] &lt;- 1 -->
  narw.indiv[, "female", which(cohort.vec <!-- %in% c(1, 3)), ] &lt;- 0 -->
  
  cat("Age ...")
  
  # Age
  ages &lt;- start_age_vec(rep(cohort.vec, n))
  narw.indiv[1, "age", animals, ] &lt;- ages
  
  cat("Length ...")
  
  # Total body length
  l.params &lt;- agL_vec(ages)
  lengths &lt;- age2length_vec(ages, l.params)
  narw.indiv[1, "length", animals, ] &lt;- lengths
  
  narw.indiv[, "length_a", animals, ] &lt;- rep(l.params[, 1], each = yrs + 1)
  narw.indiv[, "length_b", animals, ] &lt;- rep(l.params[, 2], each = yrs + 1)
  narw.indiv[, "length_c", animals, ] &lt;- rep(l.params[, 3], each = yrs + 1)
  
  cat("Mass ...")
  
  # Lean mass
  m.params &lt;- mL(n * sum(N0))
  narw.indiv[, "mass_a", animals, ] &lt;- rep(m.params[, 1], each = yrs + 1)
  narw.indiv[, "mass_b", animals, ] &lt;- rep(m.params[, 2], each = yrs + 1)
  mass &lt;- length2mass_vec(lengths, m.params)
  narw.indiv[1, "lean_mass", animals, ] &lt;- mass
  
  # Body conditon
  bc &lt;- start_bcondition_vec(rep(cohort.vec, n))
  narw.indiv[1, "bc", animals, ] &lt;- bc
  
  # Total mass
  narw.indiv[1, "tot_mass", animals, ] &lt;- mass / (1-bc)
  
  # Calving interval - mean of 5.3 years, up to apparent gaps of 13 years (Kraus et al. 2001)
  # NARWC Report Card 2022: Average inter-birth interval of 7.7 yrs, median of 8, min/max (2/13)
  # This corresponds to a Normal (7.7, 1.45)
  # Mean age at first calving = 9.53 +/- 2.32 (Kraus et al. 2001)
  # 
  # Stewart et al. 2022 -- 
  # The degree to which the energetic reserves of females are depleted during lactation may govern
  # the length of the resting period between successful pregnancies (Miller et al. 2011, Marón et al. 2015).
  
  cat("Reproduction ...")
  
  t2calf &lt;- (rep(cohort.vec, n) == 6) * random_int(sum(N0) * n)
  narw.indiv[1, "t2calf", animals, ] &lt;- t2calf
  narw.indiv[1, "trest", animals, ] &lt;- as.numeric(ifelse(t2calf == 0, 13, 1)) * (as.numeric(narw.indiv[1, "cohort", animals, ]) == 6)
  
  if (!spline) 
    narw.indiv[1, "min_bc", animals, ] &lt;- predict_m(
      model = mod,
      values = as.vector(narw.indiv[1, "tot_mass", animals, ]),
      prediction = "gest"
    ) * as.vector(narw.indiv[1, "cohort", animals, ] == 6)
   else 
    narw.indiv[1, "min_bc", animals, ] &lt;- mbc_preds(narw.indiv[1, "tot_mass", animals, ]) * (narw.indiv[1, "cohort", animals, ] == 6)
  
  
  narw.indiv[1, "birth", animals, ] &lt;- ifelse(narw.indiv[1, "trest", animals, ] == 13 &amp; narw.indiv[1, "t2calf", animals, ] == 0, 1, 0)
  narw.indiv[1, "p_surv", animals, ] &lt;- 1
  
  cat("List ...")
  
  #' ---------------------------
  # IMPORTANT 
  #' ---------------------------
  # Turn array into a list
  narw.indiv &lt;- purrr::array_branch(narw.indiv, 4) # bottleneck
  
  cat("totpop ...")
  
  # Number of individuals in each cohort
  narw.pop &lt;- array(
    data = NA, c(n, yrs + 1, nrow(cohorts)),
    dimnames = list(
      paste0("prj ", 1:n),
      paste0("yr ", 0:yrs),
      cohorts$name
    )
  )
  narw.pop[, 1, ] &lt;- rep(N0, each = n)
  
  cat("totpopinit ...")
  
  # Total population size
  tot.pop &lt;- matrix(0, n, yrs + 1, dimnames = list(paste0("prj", 1:n), paste0("yr ", 0:yrs)))
  tot.pop[, 1] &lt;- sum(N0)
  
  #'------------------------------------------------------
  # RUN PROJECTIONS
  #'------------------------------------------------------
  
  # This uses nested loops. 
  # The prj loop (outermost loop) replicates the projection &lt;n&gt; times.
  # The i loop is next, and steps across all years of projection from an initial population vector.
  
  # Set up progress bar
  pb &lt;- progress::progress_bar$new(
    format = "[:bar] :percent eta: :eta",
    total = n, clear = FALSE, width = 80
  )
  
  cat("Running projections ...")
  start.time &lt;- Sys.time()
  
  for(prj in 1:n)
    
    if(progress) pb$tick() # Update progress bar
    
    animals &lt;- 1:sum(N0)
    
    #'------------------------------------------------------
    # Loop over years
    #'------------------------------------------------------
    
    for(i in 2:(yrs+1))
      
      current.dat &lt;- as.matrix(narw.indiv[[prj]][i-1, , animals])
      alive &lt;- current.dat["alive", animals] * (current.dat["age", animals] &lt;=69)
      
      #' ----------------------------
      # SURVIVAL
      #' ----------------------------
      # Predict survival probability based on body condition
      
      if(!spline)
        
        ps &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",animals], 
                                values = current.dat["bc",animals], prediction = "surv")
        
       else 
        
        ps &lt;- alive * (surv_preds[["0"]](current.dat["bc",animals]) * (current.dat["cohort",animals] == 0) +
                         surv_preds[["1"]](current.dat["bc",animals]) * (current.dat["cohort",animals] == 1) +
                         surv_preds[["2"]](current.dat["bc",animals]) * (current.dat["cohort",animals] == 2) +
                         surv_preds[["3"]](current.dat["bc",animals]) * (current.dat["cohort",animals] == 3) +
                         surv_preds[["4"]](current.dat["bc",animals]) * (current.dat["cohort",animals] == 4) +
                         surv_preds[["5"]](current.dat["bc",animals]) * (current.dat["cohort",animals] == 5) +
                         surv_preds[["6"]](current.dat["bc",animals]) * (current.dat["cohort",animals] == 6))
      
      
      # ps &lt;- 1
      narw.indiv[[prj]][i, "p_surv", animals] &lt;- ps
      
      # Determine whether the animal survived
      alive &lt;- rbinom(n = animals, size = 1, prob = ps) * (current.dat["age", animals] &lt;=69)
      narw.indiv[[prj]][i, "alive", animals] &lt;- alive
      
      # Sex remains the same
      narw.indiv[[prj]][i, "female", animals] &lt;- current.dat["female", animals]
      
      #' ----------------------------
      # GROWTH
      #' ----------------------------
      
      # Increment age
      narw.indiv[[prj]][i, "age", animals] &lt;- alive * (current.dat["age", animals] + 1)
      
      # Increment length
      newLp &lt;- agL_vec(animals)
      
      narw.indiv[[prj]][i,"length_a", animals] &lt;- 
        ifelse(narw.indiv[[prj]][i, "age", animals] == 1, newLp[,1], current.dat["length_a", animals])
      
      narw.indiv[[prj]][i,"length_b", animals] &lt;- 
        ifelse(narw.indiv[[prj]][i, "age", animals] == 1, newLp[,2], current.dat["length_b", animals])
      
      narw.indiv[[prj]][i,"length_c", animals] &lt;- 
        ifelse(narw.indiv[[prj]][i, "age", animals] == 1, newLp[,3], current.dat["length_c", animals])
      
      narw.indiv[[prj]][i, "length", animals] &lt;-
        alive * age2length_vec(
          narw.indiv[[prj]][i, "age", animals],
          t(narw.indiv[[prj]][i, c("length_a", "length_b", "length_c"), animals])
        )
      
      # Increment lean mass
      narw.indiv[[prj]][i, "lean_mass", animals] &lt;- alive * length2mass_vec(narw.indiv[[prj]][i, "length", animals],
                                                                            t(narw.indiv[[prj]][i, c("mass_a", "mass_b"), animals]), lean = TRUE)
      
      # Predict new body condition from current body condition
      if (!spline) 
        narw.indiv[[prj]][i, "bc", animals] &lt;- alive * predict_m(
          model = mod, cohort = current.dat["cohort", animals],
          values = current.dat["bc", animals], prediction = "bc")
       else 
        narw.indiv[[prj]][i, "bc", animals] &lt;-
          alive * (bc_preds[["0"]](current.dat["bc", animals]) * (current.dat["cohort", animals] == 0) +
                     bc_preds[["1"]](current.dat["bc", animals]) * (current.dat["cohort", animals] == 1) +
                     bc_preds[["2"]](current.dat["bc", animals]) * (current.dat["cohort", animals] == 2) +
                     bc_preds[["3"]](current.dat["bc", animals]) * (current.dat["cohort", animals] == 3) +
                     bc_preds[["4"]](current.dat["bc", animals]) * (current.dat["cohort", animals] == 4) +
                     bc_preds[["5"]](current.dat["bc", animals]) * (current.dat["cohort", animals] == 5) +
                     bc_preds[["6"]](current.dat["bc", animals]) * (current.dat["cohort", animals] == 6))
      
      
      # Increment total mass
      narw.indiv[[prj]][i, "tot_mass", animals] &lt;-
        alive * narw.indiv[[prj]][i, "lean_mass", animals] / (1 - narw.indiv[[prj]][i, "bc", animals])
      
      #' ----------------------------
      # REPRODUCTION
      #' ----------------------------
      
      # Which animals are resting females?
      rest.females &lt;- (current.dat["cohort", animals] == 6)
      
      # Which animals are juvenile females that are ready to start reproducing
      juvenile.females.ofage &lt;- (current.dat["cohort", animals] == 2) * (current.dat["age", animals] &gt;= 9)
      
      # Which animals calved in previous step?
      prev.births &lt;- current.dat["birth", animals]
      
      newt2calf &lt;- ifelse(prev.births == 1, random_int(sum(prev.births), lwr = 1), 
                          ifelse(current.dat["t2calf", animals] == 0, 0, 
                                 current.dat["t2calf", animals] - 1))
      
      # Time spent in resting state - only incremented if calving event hasn't occurred, otherwise reset
      narw.indiv[[prj]][i, "t2calf", animals] &lt;- alive * rest.females * newt2calf
      
      # Years until next calving event
      narw.indiv[[prj]][i, "trest", animals] &lt;- 
        alive * (rest.females | juvenile.females.ofage) * 
        ifelse(narw.indiv[[prj]][i - 1, "trest", animals] == 13, 1, current.dat["trest", animals] + 1)
      
      # Minimum body condition needed to successfully bring fetus to term without starving
      # No evidence of reproductive senescence in right whales - Hamilton et al. (1998)
      
      if (!spline) 
        narw.indiv[[prj]][i, "min_bc", animals] &lt;-
          alive * predict_m(model = mod, values = narw.indiv[[prj]][i, "tot_mass", animals], prediction = "gest") * rest.females
       else 
        narw.indiv[[prj]][i, "min_bc", animals] &lt;-
          alive * mbc_preds(narw.indiv[[prj]][i, "tot_mass", animals]) * rest.females
      
      
      # Birth of new calf, conditional on the mother being alive, in pregnant state
      narw.indiv[[prj]][i, "birth", animals] &lt;- alive * (current.dat["cohort", animals] == 4)
      
      # Maturity - transitions between cohorts
      narw.indiv[[prj]][i, "cohort", animals] &lt;-
        alive * increment_cohort(
          cohort = narw.indiv[[prj]][i - 1, "cohort", animals],
          age = narw.indiv[[prj]][i, "age", animals],
          female = narw.indiv[[prj]][i, "female", animals],
          bc = narw.indiv[[prj]][i, "bc", animals],
          min_bc = narw.indiv[[prj]][i, "min_bc", animals],
          trest = narw.indiv[[prj]][i, "trest", animals],
          t2calf = narw.indiv[[prj]][i, "t2calf", animals])
      
      new.births &lt;- sum(narw.indiv[[prj]][i, "birth", animals])
      
      if(new.births &gt; 0)
        narw.indiv[[prj]][i, , (max(animals)+1):(max(animals)+new.births)] &lt;- add_calf(n = new.births, attr = mat.attribs)
        animals &lt;- 1:(length(animals) + new.births)
      
      
      # Number of animals in each cohort
      # Calves (male)
      narw.pop[prj, i, 1] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 0) *
                                   (narw.indiv[[prj]][i, "female", animals] == 0) *
                                   (narw.indiv[[prj]][i, "alive", animals] == 1))
      
      # Juveniles and adults (male)
      narw.pop[prj, i, 2] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 1) * (narw.indiv[[prj]][i, "alive", animals] == 1))
      narw.pop[prj, i, 3] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 3) * (narw.indiv[[prj]][i, "alive", animals] == 1))
      
      # Calves (female)
      narw.pop[prj, i, 4] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 0) *
                                   (narw.indiv[[prj]][i, "female", animals] == 1) *
                                   (narw.indiv[[prj]][i, "alive", animals] == 1))
      
      # Juvenile and reproductive adults (female)
      narw.pop[prj, i, 5] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 2) * (narw.indiv[[prj]][i, "alive", animals] == 1))
      narw.pop[prj, i, 6] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 4) * (narw.indiv[[prj]][i, "alive", animals] == 1))
      narw.pop[prj, i, 7] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 5) * (narw.indiv[[prj]][i, "alive", animals] == 1))
      narw.pop[prj, i, 8] &lt;- sum((narw.indiv[[prj]][i, "cohort", animals] == 6) * (narw.indiv[[prj]][i, "alive", animals] == 1))
      
      # Total population size
      tot.pop[prj, i] &lt;- sum(narw.indiv[[prj]][i, "alive", animals], na.rm = TRUE)
      
     # End years
   # End projections
  
  end.time &lt;- Sys.time()
  run_time &lt;- hms::round_hms(hms::as_hms(difftime(time1 = end.time, time2 = start.time, units = "auto")), 1)
  
  cat("Processing outputs ...")
  
  # narw.out &lt;- purrr::map(.x = 1:n, .f = ~
  #   reshape_array(narw.indiv[[.x]], value, yr, attr, whale) |&gt; 
  #     dplyr::mutate(attr = mat.attribs[attr]) |&gt; 
  #     tidyr::pivot_wider(names_from = attr, values_from = value) |&gt; 
  #     dplyr::mutate(prj = .x) |&gt; 
  #     dplyr::relocate(prj, .before = yr)
  # ) |&gt; do.call(what = rbind) |&gt; 
  #   data.table::data.table()
  
  # narw.out &lt;- narw.out[is.finite(rowSums(narw.out)),]
  
  narw.df &lt;- purrr::map(.x = cohorts$name, .f = ~
    narw.pop[,,.x] |&gt; 
      tibble::as_tibble() |&gt; 
      tibble::rownames_to_column(var = "prj") |&gt; 
      tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
      dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
      dplyr::mutate(cohort = stringr::str_to_sentence(.x))
  ) |&gt; do.call(what = rbind) |&gt; data.table::data.table()
  
  tot.df &lt;- tibble::as_tibble(tot.pop) |&gt; 
    tibble::rownames_to_column(var = "prj") |&gt; 
    tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
    dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
    dplyr::mutate(cohort = "North Atlantic right whales") |&gt; data.table::data.table()
  
  # births.df &lt;- purrr::map(.x = 1:n, .f = ~
  #   m &lt;- matrix(rowSums(narw.indiv[[.x]][2:(yrs+1),"birth",], na.rm = TRUE), ncol = 1)
  #   colnames(m) &lt;- .x
  #   m
  # ) |&gt; do.call(what = cbind) |&gt; 
  #   tibble::as_tibble() |&gt; 
  #   tibble::rownames_to_column(var = "year") |&gt; 
  #   dplyr::mutate(year = as.numeric(year)) |&gt; 
  #   tidyr::pivot_longer(!year, names_to = "prj", values_to = "birth") |&gt; 
  #   dplyr::select(prj, year, birth) |&gt; 
  #   dplyr::arrange(prj, year) |&gt; 
  #   data.table::data.table()
  # 
  # deaths.df &lt;- purrr::map(.x = 1:n, .f = ~
  #   m &lt;- matrix(apply(X = narw.indiv[[.x]][2:(yrs+1),"alive",],
  #                     MARGIN = 1,
  #                     FUN = function(x) 
  #     r &lt;- x[!is.na(x)]
  #     r &lt;- sum(r == 0)
  #     r
  #     ), ncol = 1)
  #   colnames(m) &lt;- .x
  #   m
  # ) |&gt; do.call(what = cbind) |&gt;
  #   tibble::as_tibble() |&gt;
  #   tibble::rownames_to_column(var = "year") |&gt;
  #   dplyr::mutate(year = as.numeric(year)) |&gt;
  #   tidyr::pivot_longer(!year, names_to = "prj", values_to = "death") |&gt;
  #   dplyr::select(prj, year, death) |&gt;
  #   dplyr::arrange(prj, year) |&gt;
  #   data.table::data.table()
  
  narw.conf &lt;- narw.df[
    , list(
      mean = mean(N),
      lwr = quantile(N, 0.025, na.rm = TRUE),
      uppr = quantile(N, 0.975, na.rm = TRUE)
    ),
    list(year, cohort)
  ] |&gt;
    dplyr::mutate(cohort = factor(cohort, levels = c(
      "Calves (male)",
      "Calves (female)",
      "Juveniles (male)",
      "Juveniles (female)",
      "Adults (male)",
      "Adults (female, pregnant)",
      "Adults (female, lactating)",
      "Adults (female, resting)"
    )))
  
  tot.conf &lt;- tot.df[
    , list(
      mean = mean(N),
      lwr = quantile(N, 0.025),
      uppr = quantile(N, 0.975)
    ),
    list(year, cohort)
  ] |&gt;
    dplyr::mutate(cohort = factor(cohort, levels = c(
      "Calves (male)",
      "Calves (female)",
      "Juveniles (male)",
      "Juveniles (female)",
      "Adults (male)",
      "Adults (female, pregnant)",
      "Adults (female, lactating)",
      "Adults (female, resting)",
      "North Atlantic right whales"
    )))
  
  p1 &lt;- plot_projection(narw.df, narw.conf)
  p2 &lt;- plot_projection(tot.df, tot.conf)
  
  if(do.plot)
    print(p1)
    print(p2)
  
  
  # Find 95<!-- % confidence intervals on final population size -->
  cat("Final population size:")
  final.pop &lt;- unname(tot.df[year == current.yr + yrs,  quantile(N, probs = c(0.5, 0.025, 0.975))])
  cat("N = ", round(final.pop[1],0), " (95<!-- % CI: ", round(final.pop[2],0), "–", round(final.pop[3],0), ")\n", sep = "") -->
  
  cat(paste0("Time elapsed: ", run_time))
  cat("")
  
  return(list(
    # dat = narw.out,
    out = list(df = rbind(narw.df, tot.df), 
               ci = rbind(narw.conf, tot.conf),
               plot = list(p1, p2))))</p></td>
      </tr><tr><td>
          <p><code><a href="print.narwsim.html">print(<i>&lt;narwsim&gt;</i>)</a></code> </p>
        </td>
        <td><p>Overview of model results</p></td>
      </tr><tr><td>
          <p><code><a href="reshape_array.html">reshape_array()</a></code> </p>
        </td>
        <td><p>predictnarwsim &lt;- function(obj,
                            yrs = 35,
                            n = 100) 
  
  # if(is.null(obj$gam)) stop("Insufficient data available. Cannot proceed with population projections.")
  # if(!identical(cohortID, 1:6)) stop("Missing cohorts in input &lt;obj&gt;. Cannot proceed with population projections.")
  # if(length(obj$gam$fit$surv$xlevels[[1]]) &lt; 6 | length(obj$gam$fit$bc$xlevels[[1]]) &lt; 6) stop("Missing factor levels in input &lt;obj&gt;. Cannot proceed with population projections.")
  
  # plogis("link" predictions + error)
  
  # Adapted from original code by Scott Creel
  # https://www.montana.edu/screel/teaching/bioe-440r-521/course-outline/stoch_projection_new.R
  # 
  # Prediction intervals
  # https://stat.ethz.ch/pipermail/r-help/2011-April/275632.html
  
  # Population estimate as per 2022 NARW report card is 340 (+/- 7).
  
  # test &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = seq(0,find_maxBC(), 0.01)), type = "link", se.fit = TRUE)
  # plot(seq(0,find_maxBC(), 0.01), plogis(test$fit), type = "l")
  # lines(seq(0,find_maxBC(), 0.01), plogis(Reduce("+", test)), lty = 2)
  # lines(seq(0,find_maxBC(), 0.01), plogis(Reduce("-", test)), lty = 2)
  # test2 &lt;- mgcv::predict.gam(mod$gam[[1]]$surv, newdata = data.frame(start_bc = 0.2), type = "response")
  # abline(v = 0.2)
  # abline(h = tesct2)
  
  cohortID &lt;- obj$param$cohortID
  cohorts &lt;- obj$param$cohorts |&gt; dplyr::slice(1) |&gt; 
    dplyr::mutate(name = gsub(", female", "", name), abb = gsub(",f", "", abb)) |&gt; 
    dplyr::bind_rows(obj$param$cohorts) |&gt; 
    dplyr::mutate(name = gsub("male, female", "female", name), abb = gsub("m,f", "f", abb))
  cohorts &lt;- cohorts[c(1,3,5,2,4,6,7,8)]
  
  # Attributes to monitor during projection
  mat.attribs &lt;- c("alive", "cohort", "female", "age", "length", "length_a", "length_b", "length_c",
                   "tot_mass", "lean_mass", "bc", "mass_a", "mass_b", "p_surv", "min_bc", "calving_int", "t2calf", "birth")
  
  # Current year
  current.yr &lt;- lubridate::year(lubridate::now())
  
  # Extract terminal functions
  mod &lt;- obj$gam$fit
  mod[["gest"]] &lt;- gam_gest
  
  #'------------------------------------------------------
  # INITIALIZATION
  #'------------------------------------------------------
  
  # Define initial population vector
  N0 &lt;- c(2, 5, 212, 2, 69, 1, 7, 61)
  names(N0) &lt;- cohorts[, name]
  
  # Create matrices and initialize them
  # rows: years &lt;yrs&gt;
  # columns: &lt;attributes&gt;
  # layers: individuals &lt;n&gt;
  # 4th dimension: replicate projection -&gt; later converted to list
  narw.indiv &lt;- array(data = NA, c(yrs + 1, length(mat.attribs), sum(N0), n), 
                      dimnames = list(paste0("yr ", 0:yrs), 
                                      mat.attribs,
                                      paste0("whale ", 1:sum(N0)),
                                      paste0("prj ", 1:n)))
  
  cohort.vec &lt;- do.call(c, sapply(X = 1:nrow(cohorts), FUN = function(x) rep(cohorts$id[x], each = N0[x])))
  
  # Alive and population cohort
  narw.indiv[1,"alive",,] &lt;- 1
  narw.indiv[1,"cohort",,] &lt;- rep(cohort.vec, n)
  
  # Sex
  #  -- Calves (male)
  narw.indiv[,"female", 1:N0[1], ] &lt;- 0  
  #  -- Calves (female)
  fem &lt;- which(cohort.vec == 0)
  narw.indiv[,"female", fem[fem &gt; N0[1]], ] &lt;- 1   
  #  -- Juveniles and adults
  narw.indiv[,"female", which(cohort.vec <!-- %in% c(2,4,5,6)), ] &lt;- 1 -->
  narw.indiv[,"female", which(cohort.vec <!-- %in% c(1,3)), ] &lt;- 0 -->
  
  # Age
  ages &lt;- start_age_vec(rep(cohort.vec, n))
  narw.indiv[1,"age", , ] &lt;- ages
  
  # Total body length
  l.params &lt;- agL_vec(ages)
  lengths &lt;- age2length_vec(ages, l.params)
  narw.indiv[1,"length", , ] &lt;- lengths
  narw.indiv[,"length_a",,] &lt;- rep(l.params[,1], each = yrs + 1)
  narw.indiv[,"length_b",,] &lt;- rep(l.params[,2], each = yrs + 1)
  narw.indiv[,"length_c",,] &lt;- rep(l.params[,3], each = yrs + 1)
  
  # Total mass
  m.params &lt;- mL(n*sum(N0))
  mass &lt;- length2mass_vec(lengths, m.params, FALSE)
  narw.indiv[,"mass_a",,] &lt;- rep(m.params[,1], each = yrs + 1)
  narw.indiv[,"mass_b",,] &lt;- rep(m.params[,2], each = yrs + 1)
  narw.indiv[1,"tot_mass", , ] &lt;- mass
  
  # Body conditon
  narw.indiv[1,"bc",,] &lt;- start_bcondition_vec(rep(cohort.vec, n))
  
  # lean mass
  narw.indiv[1,"lean_mass", , ] &lt;- mass - (narw.indiv[1,"bc",,] * mass)
  
  # Calving interval - mean of 5.3 years, up to apparent gaps of 13 years (Kraus et al. 2001)
  # NARWC Report Card 2022: Average inter-birth interval of 7.7 yrs, median of 8, min/max (2/13)
  # This corresponds to a Normal (7.7, 1.45)
  # Mean age at first calving = 9.53 +/- 2.32 (Kraus et al. 2001)
  # 
  # Stewart et al. 2022 -- 
  # The degree to which the energetic reserves of females are depleted during lactation may govern
  # the length of the resting period between successful pregnancies (Miller et al. 2011, Marón et al. 2015).
  narw.indiv[1,"calving_int",,] &lt;- (rep(cohort.vec, n) == 6) * rnorm(sum(N0)*n, mean = 7.7, sd = 1.45)
  narw.indiv[1,"t2calf",,] &lt;- round(narw.indiv[1,"calving_int",,],0)
  
  narw.indiv[1,"min_bc",,] &lt;- predict_m(model = mod,
                                        values = as.vector(narw.indiv[1,"tot_mass",,]), 
                                        prediction = "gest") * as.vector(narw.indiv[1, "cohort",, ] == 6)
  narw.indiv[1,"birth",,] &lt;- 0
  narw.indiv[1,"p_surv",,] &lt;- 1
  
  #' ---------------------------
  # IMPORTANT 
  #' ---------------------------
  # Turn array into a list - otherwise cannot add new calves within projections
  narw.indiv &lt;- purrr::array_branch(narw.indiv, 4) 
  
  # Number of individuals in each cohort
  narw.pop &lt;- array(data = NA, c(n, yrs + 1, length(N0)), 
                    dimnames = list(paste0("prj ", 1:n),
                                    paste0("yr ", 0:yrs), 
                                    cohorts$name))
  narw.pop[,1,] &lt;- rep(N0, each = n)
  
  # Total population size
  tot.pop &lt;- matrix(0, n, yrs + 1, dimnames = list(paste0("prj",1:n), paste0("yr ", 0:yrs)))
  tot.pop[,1] &lt;- sum(N0)
  
  #'------------------------------------------------------
  # RUN PROJECTIONS
  #'------------------------------------------------------
  
  # This uses nested loops. 
  # The prj loop (outermost loop) replicates the projection &lt;n&gt; times.
  # The i loop is next, and steps across all years of projection from an initial population vector.
  
  # Set up progress bar
  pb &lt;- progress::progress_bar$new(
    format = "[:bar] :percent eta: :eta",
    total = n, clear = FALSE, width = 80
  )
  
  for(prj in 1:n)
    
    pb$tick() # Update progress bar
    
    #'------------------------------------------------------
    # Loop over years
    #'------------------------------------------------------
    
    for(i in 2:(yrs+1))
      
      current.dat &lt;- as.matrix(narw.indiv[[prj]][i-1, , ])
      alive &lt;- narw.indiv[[prj]][i-1, "alive", ]
      
      #' ----------------------------
      # SURVIVAL
      #' ----------------------------
      # Predict survival probability based on body condition
      ps &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",], values = current.dat["bc",], prediction = "surv")
      narw.indiv[[prj]][i, "p_surv", ] &lt;- ps
      
      # Determine whether the animal survived
      # Maximum longevity of 69 years
      alive &lt;- rbinom(n = dim(narw.indiv[[prj]])[3], size = 1, prob = ps) * (narw.indiv[[prj]][i-1, "age", ] &lt;=69)
      narw.indiv[[prj]][i, "alive", ] &lt;- alive
      
      # Sex remains the same
      narw.indiv[[prj]][i, "female", ] &lt;- narw.indiv[[prj]][i-1, "female", ]
      
      #' ----------------------------
      # GROWTH
      #' ----------------------------
      
      # Increment age
      narw.indiv[[prj]][i, "age", ] &lt;- alive * narw.indiv[[prj]][i-1, "age", ] + 1
      
      # Increment length
      narw.indiv[[prj]][i,"length", ] &lt;- alive * age2length_vec(narw.indiv[[prj]][i, "age", ],
                                                                t(narw.indiv[[prj]][i, c("length_a", "length_b", "length_c"),]))
      
      # Increment lean mass
      narw.indiv[[prj]][i,"lean_mass", ] &lt;- alive * length2mass_vec(narw.indiv[[prj]][i, "length", ],
                                                                    t(narw.indiv[[prj]][i, c("mass_a", "mass_b"),]), lean = TRUE)
      
      # Predict new body condition from current body condition
      narw.indiv[[prj]][i, "bc", ] &lt;- alive * predict_m(model = mod, cohort = current.dat["cohort",],
                                                        values = current.dat["bc",], prediction = "bc")
      
      # Increment total mass
      narw.indiv[[prj]][i,"tot_mass", ] &lt;- alive * narw.indiv[[prj]][i,"lean_mass", ] / (1 - narw.indiv[[prj]][i,"bc", ])
      
      #' ----------------------------
      # REPRODUCTION
      #' ----------------------------
      
      narw.indiv[[prj]][i, "calving_int", ] &lt;- alive * narw.indiv[[prj]][i-1, "calving_int", ]
      narw.indiv[[prj]][i, "t2calf", ] &lt;- ifelse(narw.indiv[[prj]][i-1, "t2calf", ] - 1 &lt; 0, 0, narw.indiv[[prj]][i-1, "t2calf", ] - 1)
      
      # Minimum body condition needed to successfully bring fetus to term without starving
      # No evidence of reproductive senescence in right whales - Hamilton et al. (1998)
      narw.indiv[[prj]][i, "min_bc", ] &lt;- alive * predict_m(model = mod, values = narw.indiv[[prj]][i, "tot_mass", ], 
                                                            prediction = "gest") * (narw.indiv[[prj]][i-1, "cohort", ] == 6)
      
      # Birth of new calf
      narw.indiv[[prj]][i, "birth", ] &lt;- alive * (narw.indiv[[prj]][i, "bc", ] &gt;= narw.indiv[[prj]][i, "min_bc", ]) * 
        (narw.indiv[[prj]][i-1, "cohort", ] == 6) * (narw.indiv[[prj]][i-1, "birth", ] == 0)
      
      # Maturity - transitions between cohorts
      narw.indiv[[prj]][i, "cohort", ] &lt;- alive * increment_cohort(cohort = narw.indiv[[prj]][i-1, "cohort", ],
                                                                   age = narw.indiv[[prj]][i, "age", ],
                                                                   female = narw.indiv[[prj]][i, "female", ],
                                                                   t2calf = narw.indiv[[prj]][i, "t2calf", ])
      
      # New births
      # narw.indiv[[prj]] &lt;- new_calf(narw.indiv[[prj]][,,], year = i, attrib = mat.attribs)
      
      # Number of animals in each cohort
      # Calves (male)
      narw.pop[prj, i, 1] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 0) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Juveniles and adults (male)
      narw.pop[prj, i, 2] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 1) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 3] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 3) * (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Calves (female)
      narw.pop[prj, i, 4] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 0) *
                                   (narw.indiv[[prj]][i, "female", ] == 1) *
                                   (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Juvenile and reproductive adults (female)
      narw.pop[prj, i, 5] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 2) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 6] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 4) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 7] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 5) * (narw.indiv[[prj]][i, "alive", ] == 1))
      narw.pop[prj, i, 8] &lt;- sum((narw.indiv[[prj]][i, "cohort", ] == 6) * (narw.indiv[[prj]][i, "alive", ] == 1))
      
      # Total population size
      tot.pop[prj, i] &lt;- sum(narw.indiv[[prj]][i, "alive", ], na.rm = TRUE)
      
     # End years
   # End projections
  
  # Compile outputs
  narw.df &lt;- purrr::map(.x = cohorts$name, .f = ~
    narw.pop[,,.x] |&gt; 
      tibble::as_tibble() |&gt; 
      tibble::rownames_to_column(var = "prj") |&gt; 
      tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
      dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
      dplyr::mutate(cohort = stringr::str_to_sentence(.x))
  ) |&gt; do.call(what = rbind) |&gt; data.table::data.table()
  
  tot.df &lt;- tibble::as_tibble(tot.pop) |&gt; 
    tibble::rownames_to_column(var = "prj") |&gt; 
    tidyr::pivot_longer(!prj, names_to = "year", values_to = "N") |&gt; 
    dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
    dplyr::mutate(cohort = "North Atlantic right whales") |&gt; data.table::data.table()
  
  narw.conf &lt;- narw.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)] |&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)")))
  
  tot.conf &lt;- tot.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)]|&gt; 
    dplyr::mutate(cohort = factor(cohort, levels = c("Calves (male)",
                                                     "Calves (female)",
                                                     "Juveniles (male)", 
                                                     "Juveniles (female)", 
                                                     "Adults (male)",
                                                     "Adults (female, pregnant)",
                                                     "Adults (female, lactating)",
                                                     "Adults (female, resting)",
                                                     "North Atlantic right whales")))
  
  p1 &lt;- plot_projection(narw.df, narw.conf)
  p2 &lt;- plot_projection(tot.df, tot.conf)
  
  print(p1)
  print(p2)
  
  # Find 95<!-- % confidence intervals on final population size -->
  cat("Final population size:")
  final.pop &lt;- unname(tot.df[year == current.yr + yrs,  quantile(N, probs = c(0.5, 0.025, 0.975))])
  cat("N = ", final.pop[1], " (95<!-- % CI: ", final.pop[2], "–", final.pop[3], ")\n", sep = "") -->
  
  return(list(ind = narw.indiv, df = rbind(narw.df, tot.df), ci = rbind(narw.conf, tot.conf)))
  

predict_leslie &lt;- function(obj,
                            n = 100,
                            yrs = 35) 
  
  gg.opts &lt;- ggplot2::theme(axis.text = element_text(size = 10, color = "black"),
                            axis.text.y = element_text(margin = margin(t = 0, r = 5, b = 0, l = 0)),
                            axis.text.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
                            axis.title = element_text(size = 12),
                            axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
                            axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0)),
                            strip.background = element_rect(fill = "grey20"),
                            strip.text = element_text(colour = 'white', size = 12))
  
  
  # Adapted from original code by Scott Creel
  # https://www.montana.edu/screel/teaching/bioe-440r-521/course-outline/stoch_projection_new.R
  
  # Population estimate as per 2022 NARW report card is 340 (+/- 7).
  # The percentage of the population estimated 
  
  # cohort.id &lt;- obj$param$cohort.id
  # cohort.ab &lt;- obj$param$cohort.ab
  current.yr &lt;- lubridate::year(lubridate::now())
  
  cohorts &lt;- c("Calves (male)",
               "Juveniles (male)", 
               "Adults (male)",
               "Calves (female)",
               "Juveniles (female)", 
               "Adults (female, pregnant)",
               "Adults (female, lactating)",
               "Adults (female, resting)") |&gt; 
    tolower() |&gt; abbreviate(minlength = 6) |&gt; tibble::enframe() |&gt; 
    dplyr::rename(cohort = name, abbr = value)
  
  # Vector to store total population size for N replicate projections
  narwpop &lt;- purrr::set_names(x = cohorts$cohort) |&gt; 
    purrr::map(.f = ~matrix(0, n, yrs, dimnames = list(paste0("proj",1:n), paste0("yr ", 1:yrs))))
  
  totpop &lt;- matrix(0, n, yrs, dimnames = list(paste0("proj",1:n), paste0("yr ", 1:yrs)))
  
  # 1: Calves (male)
  # 2: Juveniles (male)
  # 3: Adults (male)
  # 4: Calves (female)
  # 5: Juveniles (female)
  # 6: Adults (female, pregnant)
  # 7: Adults (female, lactating)
  # 8: Adults (female, resting)
  
  p.fem &lt;- 0.5 # Fraction of females at birth
  p.birth &lt;- 0.5 # Probability that a pregnant female will give birth to a calf (fecundity)
  p.survival &lt;- rep(0.8, nrow(cohorts)) # Probability of survival
  names(p.survival) &lt;- cohorts
  p.recruit &lt;- c(0.7, 0.7) # Male, female
  tau_rp &lt;- 0.7 # Transition prob from resting to pregnant
  tau_pl &lt;- 0.7 # Transition prob from pregnant to lactating
  tau_lr &lt;- 0.8 # Transition prob from lactating to resting
  
  popmat &lt;- matrix(0, nrow(cohorts), nrow(cohorts))
  popmat[1, 6] &lt;- p.survival[6] * p.birth * (1 - p.fem)
  
  popmat[2, 1] &lt;- p.survival[1]
  popmat[2, 2] &lt;- p.survival[2]
  
  popmat[3, 2] &lt;- p.survival[2] * p.recruit[1]
  popmat[3, 3] &lt;- p.survival[3]
  
  popmat[4, 4] &lt;- p.survival[6] * p.birth * p.fem
  
  popmat[5, 5] &lt;- p.survival[4]
  popmat[5, 6] &lt;- p.survival[5] * (1 - p.recruit[2])
  
  popmat[6, 5] &lt;- p.survival[5] * p.recruit[2]
  popmat[6, 6] &lt;- p.survival[6] * (1 - tau_pl)
  popmat[6, 8] &lt;- p.survival[8] * tau_rp
  
  popmat[7, 6] &lt;- p.survival[6] * tau_pl
  popmat[7, 7] &lt;- p.survival[7] * (1 - tau_lr)
  
  popmat[8, 7] &lt;- p.survival[7] * tau_lr
  popmat[8, 8] &lt;- p.survival[8] * (1 - tau_rp)
  
  
  popmat &lt;- matrix(popmat, nrow = nrow(cohorts), byrow = FALSE, dimnames = list(cohorts$abbr, cohorts$abbr))
  popmat &lt;- round(popmat, 5)
  
  # STOCHASTIC LESLIE PROJECTION
  #' ----------------------------
  # This uses 4 nested loops. 
  # The p loop (outermost loop) replicates the projection &lt;n&gt; times.
  # The y loop is next, and steps across all years of projection from an initial population vector.
  # The i and j loops are innermost and draw stochastic parameters (body condition and survival)
  
  # Set up progress bar
  pb &lt;- progress::progress_bar$new(
    format = "[:bar] :percent eta: :eta",
    total = n, clear = FALSE, width = 80
  )
  
  for(p in 1:n)
    
    pb$tick() # Update progress bar
    
    # Matrix of age-class values, with one row per time step. 
    # The columns represent the numbers of individuals in each age class.
    N.mat &lt;- matrix(NA, nrow = yrs, ncol = nrow(cohorts), dimnames = list(paste("yr", 1:yrs), cohorts$abbr))
    
    # Initial population vector
    # Sums to 340 (abundance estimate as of 2022).
    N.mat[1,] &lt;- c(7, 10, 163, 8, 10, 50, 15, 77)
    
    # Begin loop for projections
    for(i in 2:yrs) 		
      
      # Set up a temporary Leslie matrix for each iteration 
      #  with the correct mean fecundities and survival rates
      leslie.mat &lt;- popmat 				
      
      # Randomly draw fecundities for each class
      # Mean of Poisson is fecundity value
      # for(j in 1:n.stages)
      #   leslie.mat[1,j] &lt;- ifelse(popmat[1,j] == 0, 0, popmat[1,j] + rnorm(1, 0, 0.01))
      # 
      
      for(j in 1:nrow(cohorts))
        for(k in 1:nrow(cohorts))
          leslie.mat[k,j] &lt;- ifelse(popmat[k,j] == 0, 0, popmat[k,j] + rnorm(1, 0, 0.01))
        
      
      
      # Randomly draw survival probabilities for each class.
      # n.ind is number of individuals to calculate live/die for
      # for(k in 1:(n.stages-1))
      #   n.ind &lt;- N.mat[(i-1),k]
      #   # Need ifelse statement to deal with the possibility that there are no individuals in that age class
      #   leslie.mat[(k+1),k] &lt;- ifelse(n.ind &gt; 1, rbinom(1,size = round(n.ind), p = les.mat[(k+1),k])/n.ind,0)
      # 
      
      # Matrix multiplication for next time-step.
      N.mat[i,] &lt;- leslie.mat <!-- %*% N.mat[(i-1),]           -->
      
     # End i loop over time
    
    for(k in seq_along(narwpop))
      narwpop[[k]][p,] &lt;- N.mat[,k]
    
    totpop[p,] &lt;- rowSums(N.mat)
    
   # Ends p loop over replicate projections
  
  # Compile outputs
  narw.df &lt;- purrr::imap(.x = narwpop, .f = ~
    tibble::as_tibble(.x) |&gt; 
      tibble::rownames_to_column(var = "proj") |&gt; 
      tidyr::pivot_longer(!proj, names_to = "year", values_to = "N") |&gt; 
      dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
      dplyr::mutate(cohort = stringr::str_to_sentence(.y))
  ) |&gt; do.call(what = rbind) |&gt; data.table::data.table()
  
  tot.df &lt;- tibble::as_tibble(totpop) |&gt; 
    tibble::rownames_to_column(var = "proj") |&gt; 
    tidyr::pivot_longer(!proj, names_to = "year", values_to = "N") |&gt; 
    dplyr::mutate(year = current.yr + as.numeric(gsub("yr ", "", year))) |&gt; 
    dplyr::mutate(cohort = "North Atlantic right whales") |&gt; data.table::data.table()
  
  narw.conf &lt;- narw.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)]
  tot.conf &lt;- tot.df[, list(mean = mean(N), lwr = quantile(N, 0.025), uppr = quantile(N, 0.975)), list(year, cohort)]
  
  # Generate plots
  make_plot &lt;- function(df, conf)
    ggplot2::ggplot() +
      # ggplot2::geom_path(data = df, aes(x = year, y = N, group = factor(proj)), colour = "lightgrey", linewidth = 0.2) +
      ggplot2::geom_path(data = conf, aes(x = year, y = mean), colour = "#1565C0") +
      ggplot2::geom_ribbon(data = conf, aes(x = year, y = mean, ymin = lwr, ymax = uppr), alpha = 0.25, fill = "#1565C0") +
      ggplot2::facet_wrap(~cohort) + 
      ggplot2::scale_x_continuous(breaks = pretty(seq(current.yr, current.yr + yrs))) +
      ggplot2::scale_y_continuous(breaks = pretty(df$N), labels = scales::comma) +
      xlab("") + ylab("Abundance") +
      gg.opts
  
  
  p1 &lt;- make_plot(tot.df, tot.conf)
  p2 &lt;- make_plot(narw.df, narw.conf)
  
  print(p1)
  print(p2)
  
  # Find 95<!-- % confidence intervals on final population size -->
  ci &lt;- tot.df[year == current.yr + yrs,  quantile(N, probs = c(0.025, 0.975))]
  
  return(ci)</p></td>
      </tr><tr><td>
          <p><code><a href="rtnorm.html">rtnorm()</a></code> </p>
        </td>
        <td><p>Random deviate from a truncated Normal distribution</p></td>
      </tr><tr><td>
          <p><code><a href="rtnorm_vec.html">rtnorm_vec()</a></code> </p>
        </td>
        <td><p>Random deviate from a truncated Normal distribution</p></td>
      </tr><tr><td>
          <p><code><a href="start_age.html">start_age</a></code> </p>
        </td>
        <td><p>Initialize age</p></td>
      </tr><tr><td>
          <p><code><a href="start_bcondition.html">start_bcondition()</a></code> </p>
        </td>
        <td><p>Initialize body condition</p></td>
      </tr><tr><td>
          <p><code><a href="start_bcondition_vec.html">start_bcondition_vec()</a></code> </p>
        </td>
        <td><p>Initialize body condition</p></td>
      </tr><tr><td>
          <p><code><a href="start_mouth.html">start_mouth</a></code> </p>
        </td>
        <td><p>Mouth-width-to-length ratio</p></td>
      </tr><tr><td>
          <p><code><a href="summary.narwproj.html">summary(<i>&lt;narwproj&gt;</i>)</a></code> </p>
        </td>
        <td><p>Population projection summary</p></td>
      </tr><tr><td>
          <p><code><a href="summary.narwsim.html">summary(<i>&lt;narwsim&gt;</i>)</a></code> </p>
        </td>
        <td><p>Model summary and diagnostics</p></td>
      </tr><tr><td>
          <p><code><a href="update.narwscenario.html">update(<i>&lt;narwscenario&gt;</i>)</a></code> </p>
        </td>
        <td><p>Update scenario object</p></td>
      </tr><tr><td>
          <p><code><a href="write.narwproj.html">write(<i>&lt;narwproj&gt;</i>)</a></code> </p>
        </td>
        <td><p>Export population projection data</p></td>
      </tr><tr><td>
          <p><code><a href="write.narwsim.html">write(<i>&lt;narwsim&gt;</i>)</a></code> </p>
        </td>
        <td><p>Export simulation data</p></td>
      </tr></tbody></table></div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by P. Bouchet, E. Pirotta, J. Hewitt, R. Schick, C. Harris, L. Thomas.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

