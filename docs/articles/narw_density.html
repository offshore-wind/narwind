<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NARW density in Canada • narwind</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="NARW density in Canada">
<meta property="og:description" content="narwind">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">narwind</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/narwind.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/narw_density.html">NARW density in Canada</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>NARW density in Canada</h1>
                        <h4 data-toc-skip class="author">Phil Bouchet,
Enrico Pirotta, Len Thomas, Catriona Harris</h4>
            <address class="author_afil">
      Centre for Research into Ecological &amp; Environmental Modelling,
University of St Andrews<br><h4 data-toc-skip class="date">2023-05-30</h4>
      
      
      <div class="hidden name"><code>narw_density.Rmd</code></div>

    </address>
</div>

    
    
<div class="section level2">
<h2 id="preamble">Preamble<a class="anchor" aria-label="anchor" href="#preamble"></a>
</h2>
<p>This document describes the approach taken to model spatial patterns
in North Atlantic Right Whale (<em>Eubalaena glacialis</em>, hereafter
NARW) density within Canadian waters (Gulf of St Lawrence and Scotian
Shelf).</p>
</div>
<div class="section level2">
<h2 id="set-up">Set up<a class="anchor" aria-label="anchor" href="#set-up"></a>
</h2>
<p>Before we start, let’s load all the required libraries, set some
global options, and define some custom functions required for the
analysis.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>tibble.width <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>pillar.neg <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>pillar.subtle <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>pillar.sigfig <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>dplyr.summarise.inform <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load required libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dnychka/fieldsRPackage" class="external-link">fields</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mfasiolo/mgcViz" class="external-link">mgcViz</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://michaeldorman.github.io/nngeo/" class="external-link">nngeo</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/" class="external-link">sp</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/" class="external-link">ggspatial</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/rgeos/" class="external-link">rgeos</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue" class="external-link">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr" class="external-link">furrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For soap film smooth</span></span>
<span><span class="co"># Scripts can be downloaded from https://github.com/dill/soap_checker</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"inst/autocrunch.R"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"inst/soap_check.R"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bespoke package functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"R/utils.R"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="spatial-data">Spatial data<a class="anchor" aria-label="anchor" href="#spatial-data"></a>
</h2>
<p>First, we bring in the right whale density surfaces produced by Duke
University; these only cover U.S. waters, and part of the Scotian Shelf
in the summer months. The latest version (v12) of the model from which
these surfaces are derived is available at 5 km resolution; however, for
consistency with previous versions, model predictions are expressed as
numbers of individuals per 100 km<sup>2</sup> (i.e., 10 x 10 km
resolution). We therefore re-scale the monthly rasters to calculate
density per 25 km<sup>2</sup> (i.e., 5 x 5 km resolution).</p>
<blockquote>
<p><strong>Note:</strong> More information on habitat-based marine
mammal density models for the U.S. Atlantic is available at <a href="https://seamap.env.duke.edu/models/Duke/EC/" class="external-link uri">https://seamap.env.duke.edu/models/Duke/EC/</a></p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"data/densitymaps"</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"density_month"</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">d</span>, .f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>  <span class="va">d.file</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"data/densitymaps"</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">d.file</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">projectRaster</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">d.file</span>, crs <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fl">25</span><span class="op">*</span><span class="va">d.file</span><span class="op">/</span><span class="fl">100</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span></span></code></pre></div>
<p>Next, we import sightings data from the North Atlantic Right Whale
Consortium (<a href="https://www.narwc.org/" class="external-link uri">https://www.narwc.org/</a>), and apply two filters:</p>
<ul>
<li>A geographic filter that discards a small number of sightings
reported in the Gulf of Mexico and throughout the northeast
Atlantic</li>
<li>A temporal filter that only retains sightings made after the
species’ documented distribution shift to the Gulf of St Lawrence in
2015 <span class="citation">(<a href="#ref-Simard2019" role="doc-biblioref">Simard <em>et al.</em> 2019</a>; <a href="#ref-Meyer-Gutbrod2022" role="doc-biblioref">Meyer-Gutbrod <em>et
al.</em> 2022</a>)</span>.</li>
</ul>
<p>We only retain sightings from animals identified in the NARW
Consortium catalog and remove potential duplicates by reducing multiple
sightings of the same individual in any given month x year to one data
point (using averaged coordinates). This helps avoid unrealistically
high densities in some grid cells.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">narwc</span> <span class="op">&lt;-</span> <span class="va">sightings</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/janitor/man/clean_names.html" class="external-link">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">longitude</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">85</span> <span class="op">&amp;</span> <span class="va">longitude</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">44</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">latitude</span> <span class="op">&lt;</span> <span class="fl">58</span> <span class="op">|</span> <span class="va">latitude</span> <span class="op">&gt;</span> <span class="fl">55</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sighting_year</span> <span class="op">&gt;=</span> <span class="fl">2015</span> <span class="op">&amp;</span> <span class="va">sighting_year</span> <span class="op">&lt;</span> <span class="fl">2021</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">eg_no</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sighting_time <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html" class="external-link">str_pad</a></span><span class="op">(</span><span class="va">sighting_time</span>, <span class="fl">4</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sighting_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">sighting_time</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">":"</span>, <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">sighting_time</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd_hms.html" class="external-link">dmy_hm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">sighting_day</span>, <span class="st">"/"</span>, <span class="va">sighting_month</span>,<span class="st">"/"</span>, <span class="va">sighting_year</span>, <span class="st">" "</span>, <span class="va">sighting_time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">month.abb</span><span class="op">[</span><span class="va">sighting_month</span><span class="op">]</span>, levels <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add projected coordinates</span></span>
<span><span class="va">narwc</span> <span class="op">&lt;-</span> <span class="fu">add_xy</span><span class="op">(</span><span class="va">narwc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split the data by eg_no, year, and month</span></span>
<span><span class="va">narwc</span> <span class="op">&lt;-</span> <span class="va">narwc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>comb <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{sighting_year}-{sighting_month}-{eg_no}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">narwc.thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/split.html" class="external-link">split</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">narwc</span>, f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">narwc</span><span class="op">$</span><span class="va">comb</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/rowSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">rbind</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"comb"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">narwc</span> <span class="op">&lt;-</span> <span class="va">narwc</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">longitude</span>, <span class="op">-</span><span class="va">latitude</span>, <span class="op">-</span><span class="va">x</span>, <span class="op">-</span><span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">narwc.thin</span>, by <span class="op">=</span> <span class="st">"comb"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">comb</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">comb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to &lt;SpatialPointsDataFrame&gt;</span></span>
<span><span class="va">narwc.sp</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPoints.html" class="external-link">SpatialPointsDataFrame</a></span><span class="op">(</span></span>
<span>  coords <span class="op">=</span> <span class="va">narwc</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  data <span class="op">=</span> <span class="va">narwc</span>,</span>
<span>  proj4string <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Lastly, we generate/bring in all the shapefiles needed for plotting
and modelling.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targets</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_config_set.html" class="external-link">tar_config_set</a></span><span class="op">(</span>store <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"_targets/"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import regions and project to CRS</span></span>
<span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu">targets</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html" class="external-link">tar_read</a></span><span class="op">(</span><span class="va">regions_eez</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spTransform.html" class="external-link">spTransform</a></span><span class="op">(</span>CRSobj <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu">targets</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html" class="external-link">tar_read</a></span><span class="op">(</span><span class="va">world</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using a zero-width buffer cleans up topology problems</span></span>
<span><span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/pred-unary-gIsValid.html" class="external-link">gIsValid</a></span><span class="op">(</span><span class="va">regions</span><span class="op">)</span></span>
<span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/misc-gBuffer.html" class="external-link">gBuffer</a></span><span class="op">(</span><span class="va">regions</span>, byid <span class="op">=</span> <span class="cn">TRUE</span>, width <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/pred-unary-gIsValid.html" class="external-link">gIsValid</a></span><span class="op">(</span><span class="va">regions</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import shapefile for Canada and project to CRS</span></span>
<span><span class="va">canada</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/shapefile.html" class="external-link">shapefile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pkg</span>, <span class="st">"data/regions/NARW_Canada_eez.shp"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spTransform.html" class="external-link">spTransform</a></span><span class="op">(</span>CRSobj <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import and crop coastline shapefile</span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span><span class="op">)</span></span>
<span><span class="va">world_sf</span> <span class="op">&lt;-</span> <span class="fu">rnaturalearth</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="st">"medium"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">world</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spTransform.html" class="external-link">spTransform</a></span><span class="op">(</span><span class="va">world</span>, CRSobj <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html" class="external-link">crop</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">574.1478</span>, <span class="fl">1934.829</span>, <span class="op">-</span><span class="fl">1534.189</span>, <span class="fl">2109.078</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">world_sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">world_sf</span>, crs <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="fl">574.1478</span>, xmax <span class="op">=</span> <span class="fl">1934.829</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="fl">1534.189</span>, ymax <span class="op">=</span> <span class="fl">2109.078</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extent of Canadian waters</span></span>
<span><span class="va">canada_ocean</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/erase.html" class="external-link">erase</a></span><span class="op">(</span><span class="va">canada</span>, <span class="va">world</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify sightings made in Canadian waters</span></span>
<span><span class="va">narwc</span> <span class="op">&lt;-</span> <span class="fu">add_country</span><span class="op">(</span><span class="va">narwc</span><span class="op">)</span></span>
<span><span class="va">narwc.sp</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">narwc</span></span>
<span></span>
<span><span class="co"># Remove sightings on land and sightings outside the study area</span></span>
<span><span class="va">onland</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/pred-binary-gIntersects.html" class="external-link">gIntersects</a></span><span class="op">(</span><span class="va">world</span>, <span class="va">narwc.sp</span>, byid <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">outarea</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/pred-binary-gIntersects.html" class="external-link">gIntersects</a></span><span class="op">(</span><span class="va">regions</span>, <span class="va">narwc.sp</span>, byid <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">narwc.sp</span> <span class="op">&lt;-</span> <span class="va">narwc.sp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">outarea</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">onland</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">narwc</span> <span class="op">&lt;-</span> <span class="va">narwc</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">outarea</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">onland</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>To model sighting density, we will need to include the areas of each
grid cell as offsets. These will equal 25 km<sup>2</sup> (the native
resolution of the density raster) across most of the study region, but
will vary where the raster meets the shore. We use a custom function
called <code>toRaster_area</code>to convert the raster grid to spatial
polygons, clip the resulting shapefile with the coastline, perform the
area calculations, and convert back to raster form.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create raster with the same resolution and origin as the </span></span>
<span><span class="co"># existing density surfaces</span></span>
<span><span class="va">d.res</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">res</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Jan</span><span class="op">)</span></span>
<span><span class="va">r.canada</span> <span class="op">&lt;-</span> <span class="fu">toRaster_area</span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span></span></code></pre></div>
<p>We can plot the sightings both as a whole and by year. The regions
shown are those defined under PCoMS - however, note that they have been
extended out to the edge of the U.S./Canadian EEZs to be consistent with
the original extent of the Duke University density surface products.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Whole range</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">regions</span>, axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">canada</span>, col <span class="op">=</span> <span class="st">"lightblue"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world</span>, col <span class="op">=</span> <span class="st">"lightgrey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">narwc.sp</span>, add <span class="op">=</span> <span class="cn">T</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="../../../../../My%20Drive/Documents/git/narwind/articles/NARW_sightings.jpeg"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot sightings per year</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">regions</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">world</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">narwc.sp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sighting_year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">0</span>, r <span class="op">=</span> <span class="fl">0</span>, b <span class="op">=</span> <span class="fl">0</span>, l <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="../../../../../My%20Drive/Documents/git/narwind/articles/narw_sightings_per_year.jpg"></p>
</div>
<div class="section level2">
<h2 id="sighting-density">Sighting density<a class="anchor" aria-label="anchor" href="#sighting-density"></a>
</h2>
<p>Next, we calculate the monthly density of sightings per 5 x 5 km grid
cell, averaged across years. Note that there are <strong>no
effort</strong> data available here, so this assumes that the entire
study area has been adequately/homogeneously covered, and that each
sighting is of a single individual, not of a group of whales. We can
tally sightings to identify the months of the year when NARW are present
in Canadian waters, and we set <code>n = 10</code> as the minimum number
of sightings needed for modelling. In the table below,
<code>count</code> represents the number of sightings for each month in
the initial dataset, and <code>n</code> the number of sightings after
setting any values &gt; 10 to zero.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Minimum number of sightings required to model density</span></span>
<span><span class="va">min.n</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Number of sightings per month</span></span>
<span><span class="va">df.count</span> <span class="op">&lt;-</span> <span class="va">month.abb</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="op">{</span><span class="va">narwc</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Canada"</span>, <span class="va">month</span> <span class="op">==</span> <span class="va">.x</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html" class="external-link">enframe</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>month <span class="op">=</span> <span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">value</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">month</span>, levels <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">count</span> <span class="op">&gt;=</span> <span class="va">min.n</span>, <span class="va">count</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">df.count</span>, format <span class="op">=</span> <span class="st">"simple"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define months when NARW are in Canada</span></span>
<span><span class="va">narw.months</span> <span class="op">&lt;-</span> <span class="va">df.count</span><span class="op">[</span><span class="va">df.count</span><span class="op">$</span><span class="va">n</span> <span class="op">&gt;</span><span class="fl">0</span>,<span class="op">]</span><span class="op">$</span><span class="va">month</span></span>
<span></span>
<span><span class="co"># Split the data by month</span></span>
<span><span class="va">narwc.bymonth</span> <span class="op">&lt;-</span> <span class="va">narwc</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Canada"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/split.html" class="external-link">split</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, f <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">month</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate sightings density in each raster grid cell in each month</span></span>
<span><span class="va">r.dens</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>  .x <span class="op">=</span> <span class="va">month.abb</span>,</span>
<span>  .f <span class="op">=</span> <span class="op">~</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">df.count</span><span class="op">[</span><span class="va">df.count</span><span class="op">$</span><span class="va">month</span> <span class="op">==</span> <span class="va">.x</span>, <span class="op">]</span><span class="op">$</span><span class="va">n</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">r.canada</span><span class="op">$</span><span class="va">d</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">uyr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">narwc.bymonth</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sighting_year</span><span class="op">)</span></span>
<span>      <span class="va">r.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>        X <span class="op">=</span> <span class="va">uyr</span>,</span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">yr</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">rpts</span> <span class="op">&lt;-</span> <span class="va">narwc.bymonth</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sighting_year</span> <span class="op">==</span> <span class="va">yr</span><span class="op">)</span></span>
<span>          <span class="va">rpts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">rpts</span>, f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">day</a></span><span class="op">(</span><span class="va">rpts</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>          <span class="va">rpts.count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">rpts</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPoints.html" class="external-link">SpatialPointsDataFrame</a></span><span class="op">(</span></span>
<span>              coords <span class="op">=</span> <span class="va">y</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>              data <span class="op">=</span> <span class="va">y</span>, proj4string <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="fu">pointcount</span><span class="op">(</span><span class="va">r.canada</span><span class="op">$</span><span class="va">d</span>, <span class="va">rr</span>, <span class="va">canada_ocean</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span>          <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="va">rpts.count</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">uyr</span><span class="op">)</span></span>
<span>      <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="va">r.out</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Average density across years for each month</span></span>
<span><span class="va">r.narw</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">r.dens</span>, .f <span class="op">=</span> <span class="op">~</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/calc.html" class="external-link">calc</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.x</span>, fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to &lt;data.frame&gt;</span></span>
<span><span class="va">df.narw</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">r.narw</span>, .f <span class="op">=</span> <span class="op">~</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">.x</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">layer</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">df.narw</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">month.abb</span>, .f <span class="op">=</span> <span class="op">~</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">df.narw</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>, month <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">rbind</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>count <span class="op">=</span> <span class="va">layer</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="grid-cell-areas">Grid cell areas<a class="anchor" aria-label="anchor" href="#grid-cell-areas"></a>
</h2>
<p>Before we start building the model, we ought to check that cell areas
are correct, and add them to the working <code>data.frame</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add areas to </span></span>
<span><span class="va">r.poly</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterToPolygons.html" class="external-link">rasterToPolygons</a></span><span class="op">(</span><span class="va">r.canada</span><span class="op">)</span></span>
<span><span class="va">df.narw</span><span class="op">$</span><span class="va">area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">r.poly</span><span class="op">$</span><span class="va">area</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">month.abb</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df.narw</span> <span class="op">&lt;-</span> <span class="fu">add_country</span><span class="op">(</span><span class="va">df.narw</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r.overlap</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html" class="external-link">over</a></span><span class="op">(</span><span class="va">r.poly</span>, <span class="va">world</span>, returnList <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">r.overlap</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">r.overlap</span>, .f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r.overlap</span> <span class="op">&lt;-</span> <span class="va">r.overlap</span> <span class="op">==</span> <span class="fl">1</span></span>
<span><span class="va">r.poly.overlap</span> <span class="op">&lt;-</span> <span class="va">r.poly</span><span class="op">[</span><span class="va">r.overlap</span>,<span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">canada_ocean</span>, main <span class="op">=</span> <span class="st">"Raster cells intersecting the coast"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world</span>, col <span class="op">=</span> <span class="st">"grey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r.poly.overlap</span>, col <span class="op">=</span> <span class="st">"orange"</span>, border <span class="op">=</span> <span class="st">"orange"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="narw_density_files/figure-html/plotcheck-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">canada_ocean</span>, main <span class="op">=</span> <span class="st">"Cell areas (sq. km)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world</span>, col <span class="op">=</span> <span class="st">"grey"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r.canada</span><span class="op">$</span><span class="va">area</span>, col <span class="op">=</span> <span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/matplotlib.html" class="external-link">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="narw_density_files/figure-html/plotcheck-2.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="generalized-additive-model">Generalized additive model<a class="anchor" aria-label="anchor" href="#generalized-additive-model"></a>
</h2>
<div class="section level3">
<h3 id="input-data">Input data<a class="anchor" aria-label="anchor" href="#input-data"></a>
</h3>
<p>Next, we generate the dataset needed for fitting a generalized
additive model (GAM) to NARW densities. We only know the locations where
animals have been observed, so we assume that animals were absent in
grid cells where sightings were not reported. We subset those grid cells
to avoid having an unrealistically large number of absences, which could
complicate model fitting. This is achieved by creating a regular grid
over the study region and taking the grid nodes as absence points. We
use exclusion buffers around sightings to prevent absence points from
being too close to areas with positive density values. An example plot
for the month of July is presented below.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create regular grid across the study area to avoid over-inflation of zeroes</span></span>
<span><span class="co"># Use the buffer function from &lt;terra&gt; to ensure no points fall on land</span></span>
<span><span class="co"># including islands</span></span>
<span></span>
<span><span class="co"># Set random seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20221017</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r.grid</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spsample.html" class="external-link">makegrid</a></span><span class="op">(</span><span class="va">canada_ocean</span>, cellsize <span class="op">=</span> <span class="fl">75</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPoints.html" class="external-link">SpatialPoints</a></span><span class="op">(</span>proj4string <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">r.grid</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/topo-bin-gIntersection.html" class="external-link">gIntersection</a></span><span class="op">(</span>spgeom1 <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/buffer.html" class="external-link">buffer</a></span><span class="op">(</span><span class="va">canada_ocean</span>, width <span class="op">=</span> <span class="op">-</span><span class="fl">10</span><span class="op">)</span>, spgeom2 <span class="op">=</span> <span class="va">r.grid</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">r.grid</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">r.grid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r.grid</span>, col <span class="op">=</span> <span class="st">"blue"</span>, cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">world</span>, add <span class="op">=</span> <span class="cn">T</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># par(mfrow = c(2,4))</span></span>
<span></span>
<span><span class="va">df.month</span> <span class="op">&lt;-</span> <span class="va">month.abb</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">df.count</span><span class="op">[</span><span class="va">df.count</span><span class="op">$</span><span class="va">month</span> <span class="op">==</span> <span class="va">.x</span>,<span class="op">]</span><span class="op">$</span><span class="va">n</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span></span>
<span>      </span>
<span>      <span class="cn">NULL</span></span>
<span>      </span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      </span>
<span>      <span class="co"># Extract the data for the month of interest</span></span>
<span>      <span class="va">df.filter</span> <span class="op">&lt;-</span> <span class="va">df.narw</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="va">.x</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Extract cells that have sightings</span></span>
<span>      <span class="va">pos</span> <span class="op">&lt;-</span> <span class="va">df.filter</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">count</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Convert locations into a polygon and buffer the resulting area</span></span>
<span>      <span class="va">pos.poly</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterFromXYZ.html" class="external-link">rasterFromXYZ</a></span><span class="op">(</span><span class="va">pos</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"count"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                                        res <span class="op">=</span> <span class="va">d.res</span>, crs <span class="op">=</span> <span class="fu"><a href="../reference/narw_crs.html">narw_crs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterToPolygons.html" class="external-link">rasterToPolygons</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    </span>
<span>      <span class="va">r.dissolve</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/topo-bin-gUnion.html" class="external-link">gUnionCascaded</a></span><span class="op">(</span><span class="va">pos.poly</span><span class="op">)</span></span>
<span>      <span class="va">r.buffer</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/misc-gBuffer.html" class="external-link">gBuffer</a></span><span class="op">(</span><span class="va">r.dissolve</span>, width <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Remove grid points that fall within the buffer</span></span>
<span>      <span class="va">r.grid.zero</span> <span class="op">&lt;-</span> <span class="fu">rgeos</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rgeos/man/topo-bin-gDifference.html" class="external-link">gDifference</a></span><span class="op">(</span><span class="va">r.grid</span>, <span class="va">r.buffer</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="va">.x</span> <span class="op">==</span> <span class="st">"Jul"</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">canada_ocean</span>, main <span class="op">=</span> <span class="va">.x</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pos.poly</span>, add <span class="op">=</span> <span class="cn">T</span>,<span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r.buffer</span>, border <span class="op">=</span> <span class="st">"orange"</span>, add <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r.grid.zero</span>, col <span class="op">=</span> <span class="st">"blue"</span>, add <span class="op">=</span> <span class="cn">T</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">canada_ocean</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="va">df.zero</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html" class="external-link">coordinates</a></span><span class="op">(</span><span class="va">r.grid.zero</span><span class="op">)</span>, </span>
<span>                            count <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                            month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pos</span><span class="op">$</span><span class="va">month</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                            area <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">r.canada</span><span class="op">$</span><span class="va">area</span>, <span class="va">r.grid.zero</span><span class="op">)</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">df.zero</span> <span class="op">&lt;-</span> <span class="fu">add_country</span><span class="op">(</span><span class="va">df.zero</span><span class="op">)</span></span>
<span>      <span class="va">df.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://www.math.uzh.ch/pages/spam/reference/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pos</span>, <span class="va">df.zero</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">df.out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>      <span class="va">df.out</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="soap-film">Soap film<a class="anchor" aria-label="anchor" href="#soap-film"></a>
</h3>
<p>Conventional bivariate spatial splines may perform poorly in the
presence of physical boundary features such as islands and peninsulae,
so we opt for a soap film smooth instead, as soap films are appropriate
for finite area smoothing over complex spatial domains such as the U.S./
Canada coastline. The number of internal knots is a compromise between
model resolution and computing speed. Note that we need to set
constraints on boundary conditions to indicate that NARW density tends
to zero towards those boundaries that align with the shore. However,
other boundaries fall in water, where density may be positive (e.g., the
U.S. / Canada border). This is a tricky situation, as mixed boundaries
such as these are not allowed in soap film smooths (David Miller,
personal communication). As a workaround, we run two models: one with
constraints placed on island boundaries only (but not the mainland), and
another with constraints on all boundaries. We combine resulting
predictions to get the final output.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Code taken from Fall et al. (2018) </span></span>
<span><span class="co"># https://doi.org/10.1371/journal.pone.0205921.s001</span></span>
<span></span>
<span><span class="co"># Generate grid</span></span>
<span><span class="va">ocean.xy</span> <span class="op">&lt;-</span> <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">85</span><span class="op">)</span></span>
<span><span class="va">gx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, length.out <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="va">gy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">canada_ocean</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, length.out <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="va">gp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="va">gx</span>, <span class="va">gy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The study area has a highly complex coastline, including many</span></span>
<span><span class="co"># small islands, which throw errors if included.</span></span>
<span><span class="co"># We only retain the seven largest coastline features (incl. the mainland)</span></span>
<span><span class="va">b.ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The GAM needs the border coordinates as a list of lists,</span></span>
<span><span class="co"># where each list describes one border segment or island:</span></span>
<span><span class="va">oceancoords</span> <span class="op">&lt;-</span> <span class="va">ocean.xy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,<span class="va">piece</span><span class="op">)</span></span>
<span><span class="va">borderlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">oceancoords</span>, <span class="va">oceancoords</span><span class="op">$</span><span class="va">piece</span><span class="op">)</span></span>
<span><span class="va">border.narw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">borderlist</span>, <span class="va">`[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">borderlist</span> <span class="op">&lt;-</span> <span class="va">borderlist</span><span class="op">[</span><span class="va">b.ind</span><span class="op">]</span></span>
<span><span class="va">border.narw</span> <span class="op">&lt;-</span> <span class="va">border.narw</span><span class="op">[</span><span class="va">b.ind</span><span class="op">]</span></span>
<span><span class="va">border.narw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">b.ind</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list.data.frame</a></span><span class="op">(</span><span class="va">border.narw</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The inSide can be used to select knots that are inside the border</span></span>
<span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="va">gp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">gp</span>, <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/inSide.html" class="external-link">inSide</a></span><span class="op">(</span>bnd <span class="op">=</span> <span class="va">border.narw</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># This passes the soap_check test but still returns an error</span></span>
<span><span class="co"># during model fitting – we remove any remaining offending  knots manually.</span></span>
<span></span>
<span><span class="va">text.counter</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">text.counter</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">test.dsm</span> <span class="op">&lt;-</span> <span class="fu">evaluate</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/evaluate/man/evaluate.html" class="external-link">evaluate</a></span><span class="op">(</span></span>
<span>  <span class="st">"mgcv::gam(formula = count ~ offset(log(area)) + </span></span>
<span><span class="st">  s(x, y, bs = \"so\", xt = list(bnd = border.narw)), </span></span>
<span><span class="st">  data = df.month[[\"Jul\"]][1:20,], </span></span>
<span><span class="st">  method = \"REML\",</span></span>
<span><span class="st">  family = tw(link = \"log\"),</span></span>
<span><span class="st">  knots = knots)"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">test.dsm</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">21</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Error in crunch.knots"</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>    <span class="va">error.msg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">test.dsm</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">error.msg</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html" class="external-link">str_sub</a></span><span class="op">(</span><span class="va">error.msg</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gregexpr</a></span><span class="op">(</span><span class="st">":"</span>, <span class="va">error.msg</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">error.msg</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">problem.knot</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/parse_number.html" class="external-link">parse_number</a></span><span class="op">(</span><span class="va">error.msg</span><span class="op">)</span></span>
<span>    <span class="va">knots</span> <span class="op">&lt;-</span> <span class="va">knots</span><span class="op">[</span><span class="op">-</span><span class="va">problem.knot</span>, <span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Removing knot:"</span>, <span class="va">problem.knot</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="va">text.counter</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">text.counter</span> <span class="op">&lt;-</span> <span class="st">"Stop"</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="op">}</span> <span class="co"># End while loop</span></span>
<span></span>
<span><span class="co"># Set constraint on boundary conditions around all islands but not the coastline</span></span>
<span><span class="va">border.islands</span> <span class="op">&lt;-</span> <span class="va">border.narw</span></span>
<span><span class="va">border.islands</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">border.islands</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">border.islands</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">border.islands</span><span class="op">)</span><span class="op">]</span>, .f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">.x</span></span>
<span>    <span class="va">tmp</span><span class="op">$</span><span class="va">f</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">tmp</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set constraint on boundary conditions around all boundaries</span></span>
<span><span class="va">border.narw</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">border.narw</span>, .f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">.x</span></span>
<span>  <span class="va">tmp</span><span class="op">$</span><span class="va">f</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">tmp</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check results</span></span>
<span><span class="co"># soap_check(bnd = border.narw, knots = knots)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h3>
<p>We fit a hierarchical GAM, coded as model <code>GI</code> from <span class="citation">Pedersen <em>et al.</em> (<a href="#ref-Pedersen2019" role="doc-biblioref">2019</a>)</span>. This model allows for a shared
spatial trend, from which deviations may occur in each month. It is
therefore set up with a single common smoother, plus monthly smoothers
with differing levels of wiggliness. We use the <code>bam</code> engine
and fast REML to speed up calculations.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model.hgam.isl</span> <span class="op">&lt;-</span> <span class="st">"count ~ offset(log(area)) + s(x, y, m = 2, bs = \"so\", xt = list(bnd = border.islands)) + s(x, y, by = month, bs = \"so\", m = 1, xt = list(bnd = border.islands)) + s(month, bs = \"re\", k = length(narw.months))"</span></span>
<span></span>
<span><span class="va">model.hgam.main</span> <span class="op">&lt;-</span> <span class="st">"count ~ offset(log(area)) + s(x, y, m = 2, bs = \"so\", xt = list(bnd = border.narw)) + s(x, y, by = month, bs = \"so\", m = 1, xt = list(bnd = border.narw)) + s(month, bs = \"re\", k = length(narw.months))"</span></span>
<span></span>
<span><span class="va">df.hgam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">df.month</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hgam.isl</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/bam.html" class="external-link">bam</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">model.hgam.isl</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df.hgam</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"fREML"</span>,</span>
<span>  discrete <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/Tweedie.html" class="external-link">tw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  knots <span class="op">=</span> <span class="va">knots</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hgam.main</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/bam.html" class="external-link">bam</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">model.hgam.main</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">df.hgam</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"fREML"</span>,</span>
<span>  discrete <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/Tweedie.html" class="external-link">tw</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  knots <span class="op">=</span> <span class="va">knots</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hgam.isl</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: Tweedie(p=1.107) </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## count ~ offset(log(area)) + s(x, y, m = 2, bs = "so", xt = list(bnd = border.islands)) + </span></span>
<span><span class="co">##     s(x, y, by = month, bs = "so", m = 1, xt = list(bnd = border.islands)) + </span></span>
<span><span class="co">##     s(month, bs = "re", k = length(narw.months))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)  -6.5598     0.2711  -24.19   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##                    edf Ref.df      F  p-value    </span></span>
<span><span class="co">## s(x,y)          33.591 41.487  7.497  &lt; 2e-16 ***</span></span>
<span><span class="co">## s(x,y):monthAug  6.130  8.279  2.986 0.002177 ** </span></span>
<span><span class="co">## s(x,y):monthJul  3.403  4.446  3.879 0.002891 ** </span></span>
<span><span class="co">## s(x,y):monthJun  1.000  1.000 14.667 0.000135 ***</span></span>
<span><span class="co">## s(x,y):monthMay  9.702 13.055  2.137 0.010576 *  </span></span>
<span><span class="co">## s(x,y):monthNov 11.105 14.108  5.868  &lt; 2e-16 ***</span></span>
<span><span class="co">## s(x,y):monthOct  8.228 11.522  4.197 2.95e-06 ***</span></span>
<span><span class="co">## s(x,y):monthSep  6.064  8.608  2.582 0.006916 ** </span></span>
<span><span class="co">## s(month)         3.286  6.000  1.644 0.002746 ** </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Rank: 695/696</span></span>
<span><span class="co">## R-sq.(adj) =  0.656   Deviance explained =   80%</span></span>
<span><span class="co">## fREML = -512.4  Scale est. = 0.031314  n = 1311</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hgam.main</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: Tweedie(p=1.115) </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## count ~ offset(log(area)) + s(x, y, m = 2, bs = "so", xt = list(bnd = border.narw)) + </span></span>
<span><span class="co">##     s(x, y, by = month, bs = "so", m = 1, xt = list(bnd = border.narw)) + </span></span>
<span><span class="co">##     s(month, bs = "re", k = length(narw.months))</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)  -6.7639     0.2194  -30.82   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##                       edf Ref.df      F p-value    </span></span>
<span><span class="co">## s(x,y)          3.408e+01     77  5.923 &lt; 2e-16 ***</span></span>
<span><span class="co">## s(x,y):monthAug 2.051e-05     77  0.000 0.48990    </span></span>
<span><span class="co">## s(x,y):monthJul 5.037e+00     77  0.563 0.25247    </span></span>
<span><span class="co">## s(x,y):monthJun 4.829e-05     76  0.000 0.49840    </span></span>
<span><span class="co">## s(x,y):monthMay 8.285e+00     76  1.751 0.02889 *  </span></span>
<span><span class="co">## s(x,y):monthNov 1.220e+01     74  2.837 &lt; 2e-16 ***</span></span>
<span><span class="co">## s(x,y):monthOct 7.127e+00     77  0.349 0.00220 ** </span></span>
<span><span class="co">## s(x,y):monthSep 6.395e+00     77  0.425 0.00552 ** </span></span>
<span><span class="co">## s(month)        4.865e+00      6 10.919 &lt; 2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.628   Deviance explained = 78.7%</span></span>
<span><span class="co">## fREML = -447.28  Scale est. = 0.033344  n = 1311</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Residual checks</span></span>
<span><span class="co"># par(mfrow = c(2,2))</span></span>
<span><span class="co"># my_gam.check(hgam.isl)</span></span>
<span><span class="co"># abline(a = 0, b = 1, col = "orange")</span></span>
<span><span class="co"># par(mfrow = c(1,1))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># par(mfrow = c(2,2))</span></span>
<span><span class="co"># my_gam.check(hgam.main)</span></span>
<span><span class="co"># abline(a = 0, b = 1, col = "orange")</span></span>
<span><span class="co"># par(mfrow = c(1,1))</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-predictions">Model predictions<a class="anchor" aria-label="anchor" href="#model-predictions"></a>
</h3>
<p>Lastly, we generate predictions from all models and visualize them.
We merge them with existing density surfaces from Duke University in
order to get maps that span the entire right whale range. Note that the
code is set up to retain the values from the original Duke surfaces in
areas where rasters overlap, as these are built from dedicated survey
data and are therefore more reliable.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds.df.hgam</span> <span class="op">&lt;-</span> <span class="va">month.abb</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">r.canada</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">d</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">rbind</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Nhat_isl <span class="op">=</span> <span class="fl">0</span>, Nhat_main <span class="op">=</span> <span class="fl">0</span>, Nhat <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate model predictions</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds.hgam.isl</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/future_map.html" class="external-link">future_map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">narw.months</span>, </span>
<span>             .f <span class="op">=</span> <span class="op">~</span><span class="fu">predict_hgam</span><span class="op">(</span>object <span class="op">=</span> <span class="va">hgam.isl</span>, </span>
<span>                    newdata <span class="op">=</span> <span class="va">preds.df.hgam</span><span class="op">[</span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">.x</span>,<span class="op">]</span>, </span>
<span>                                type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">c</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds.hgam.main</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/future_map.html" class="external-link">future_map</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">narw.months</span>, </span>
<span>             .f <span class="op">=</span> <span class="op">~</span><span class="fu">predict_hgam</span><span class="op">(</span>object <span class="op">=</span> <span class="va">hgam.main</span>, </span>
<span>                    newdata <span class="op">=</span> <span class="va">preds.df.hgam</span><span class="op">[</span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">.x</span>,<span class="op">]</span>, </span>
<span>                                type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">c</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">Nhat_isl</span><span class="op">[</span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">narw.months</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">preds.hgam.isl</span></span>
<span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">Nhat_main</span><span class="op">[</span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">narw.months</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">preds.hgam.main</span></span>
<span></span>
<span><span class="va">preds.df.hgam</span> <span class="op">&lt;-</span> <span class="va">preds.df.hgam</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Nhat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Nhat_isl</span>, <span class="va">Nhat_main</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create prediction rasters</span></span>
<span><span class="co"># Canada only</span></span>
<span><span class="va">d.narwc.canada</span> <span class="op">&lt;-</span> <span class="va">month.abb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">preds.list.hgam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">preds.df.hgam</span>, f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">month</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterFromXYZ.html" class="external-link">rasterFromXYZ</a></span><span class="op">(</span><span class="va">preds.list.hgam</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"Nhat"</span><span class="op">)</span><span class="op">]</span>, res <span class="op">=</span> <span class="va">d.res</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Whole range</span></span>
<span><span class="va">d.narwc</span> <span class="op">&lt;-</span> <span class="va">month.abb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>    <span class="va">preds.list.hgam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">preds.df.hgam</span>, f <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">preds.df.hgam</span><span class="op">$</span><span class="va">month</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">pdata.r</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterFromXYZ.html" class="external-link">rasterFromXYZ</a></span><span class="op">(</span><span class="va">preds.list.hgam</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"Nhat"</span><span class="op">)</span><span class="op">]</span>, res <span class="op">=</span> <span class="va">d.res</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">d</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>, <span class="va">pdata.r</span><span class="op">$</span><span class="va">Nhat</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span>, <span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="op">{</span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">.x</span>; <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Nhat"</span>; <span class="va">tmp</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge with density surface</span></span>
<span><span class="va">d.narwc.df</span> <span class="op">&lt;-</span> <span class="va">month.abb</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="op">~</span><span class="op">{</span></span>
<span>  <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">d.narwc</span><span class="op">[[</span><span class="va">.x</span><span class="op">]</span><span class="op">]</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">rbind</span><span class="op">)</span></span></code></pre></div>
<p>Model predictions are shown below, first for Canadian waters, then
for the entire species’ range.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_preds</span><span class="op">(</span><span class="va">preds.df.hgam</span>, plot.sightings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">plot_preds</span><span class="op">(</span><span class="va">d.narwc.df</span>, plot.sightings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="../../../../../My%20Drive/Documents/git/narwind/articles/predicted_density_canada.jpeg"></p>
<p><img src="../../../../../My%20Drive/Documents/git/narwind/articles/predicted_density_range.jpeg"></p>
<p>To make sure that NARW don’t wander out into deep, offshore waters
during the simulation, we can crop the rasters above a minimum density
threshold. The resulting spatial support is shown below.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sim_support</span><span class="op">(</span><span class="va">d.narwc</span>, min_density <span class="op">=</span> <span class="fl">0.001</span>, force <span class="op">=</span> <span class="cn">TRUE</span>, sightings <span class="op">=</span> <span class="va">sightings</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Sightings in support: 96 %</span></span></code></pre>
<p><img src="narw_density_files/figure-html/simsupport-1.png" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="abundance-in-canada">Abundance in Canada<a class="anchor" aria-label="anchor" href="#abundance-in-canada"></a>
</h2>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu">sum_Nhat</span><span class="op">(</span><span class="va">d.narwc.df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Average: 29.3%</span></span></code></pre>
<table class="table">
<thead><tr class="header">
<th align="left">region</th>
<th align="left">month</th>
<th align="right">Nhat</th>
<th align="right">perc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">GSL</td>
<td align="left">Jan</td>
<td align="right">0</td>
<td align="right">0.0</td>
</tr>
<tr class="even">
<td align="left">GSL</td>
<td align="left">Feb</td>
<td align="right">0</td>
<td align="right">0.0</td>
</tr>
<tr class="odd">
<td align="left">GSL</td>
<td align="left">Mar</td>
<td align="right">0</td>
<td align="right">0.0</td>
</tr>
<tr class="even">
<td align="left">GSL</td>
<td align="left">Apr</td>
<td align="right">0</td>
<td align="right">0.0</td>
</tr>
<tr class="odd">
<td align="left">GSL</td>
<td align="left">May</td>
<td align="right">144</td>
<td align="right">42.9</td>
</tr>
<tr class="even">
<td align="left">GSL</td>
<td align="left">Jun</td>
<td align="right">96</td>
<td align="right">28.6</td>
</tr>
<tr class="odd">
<td align="left">GSL</td>
<td align="left">Jul</td>
<td align="right">83</td>
<td align="right">24.7</td>
</tr>
<tr class="even">
<td align="left">GSL</td>
<td align="left">Aug</td>
<td align="right">56</td>
<td align="right">16.7</td>
</tr>
<tr class="odd">
<td align="left">GSL</td>
<td align="left">Sep</td>
<td align="right">79</td>
<td align="right">23.5</td>
</tr>
<tr class="even">
<td align="left">GSL</td>
<td align="left">Oct</td>
<td align="right">156</td>
<td align="right">46.4</td>
</tr>
<tr class="odd">
<td align="left">GSL</td>
<td align="left">Nov</td>
<td align="right">75</td>
<td align="right">22.3</td>
</tr>
<tr class="even">
<td align="left">GSL</td>
<td align="left">Dec</td>
<td align="right">0</td>
<td align="right">0.0</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Meyer-Gutbrod2022" class="csl-entry">
Meyer-Gutbrod EL, Davies KTA, Johnson CL, Plourde S, Sorochan KA, Kenney
RD, Ramp C, Gosselin J-F, Lawson JW, Greene CH (2022). <span class="nocase">Redefining North Atlantic right whale habitat-use
patterns under climate change</span>. <em>Limnology and
Oceanography</em> <strong>n/a</strong>. DOI: <a href="https://doi.org/10.1002/lno.12242" class="external-link">10.1002/lno.12242</a>
</div>
<div id="ref-Pedersen2019" class="csl-entry">
Pedersen EJ, Miller DL, Simpson GL, Ross N (2019). <span class="nocase">Hierarchical generalized additive models in ecology: An
introduction with mgcv</span>. <em>PeerJ</em> <strong>7</strong>, e6876.
DOI: <a href="https://doi.org/10.7717/peerj.6876" class="external-link">10.7717/peerj.6876</a>
</div>
<div id="ref-Simard2019" class="csl-entry">
Simard Y, Roy N, Giard S, Aulanier F (2019). <span class="nocase">North
Atlantic right whale shift to the Gulf of St. Lawrence in 2015, revealed
by long-term passive acoustics</span>. <em>Endangered Species
Research</em> <strong>40</strong>, 271–284. DOI: <a href="https://doi.org/10.3354/esr01005" class="external-link">10.3354/esr01005</a>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Phil Bouchet, Pirotta Enrico, Hewitt Josh, Schick Rob, Harris Catriona, Thomas Len.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
